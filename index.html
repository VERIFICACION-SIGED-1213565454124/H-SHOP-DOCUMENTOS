<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Generador de Documentos - Estatus de Solicitud</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

    <style>
        /* Estilos generales */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 850px;
            margin: 0 auto;
            padding: 25px;
            background-color: #f4f4f9;
            position: relative;
            padding-bottom: 100px;
        }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 25px; }
        .input-group, .form-section { background-color: #ffffff; padding: 20px; margin-bottom: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-bottom: 15px; }
        label { display: block; margin-top: 10px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], textarea, input[type="file"], input[type="password"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .date-container { display:flex; justify-content:space-between; gap:10px; }
        .date-container input { width:100%; }
        textarea { height:120px; resize:vertical; }

        /* Botones generales */
        .btn-action {
            background-color: #e67e22;
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        .btn-action:hover { background-color: #d35400; }
        .back-button { background-color: #95a5a6; width:auto; padding:10px 15px; font-size:1em; }

        .btn-menu { color:white; padding:15px 20px; border:none; border-radius:5px; cursor:pointer; font-size:1.1em; width:100%; margin-top:10px; transition: background-color 0.3s;}
        .btn-carta { background-color:#f1c40f;}
        .btn-receta { background-color:#27ae60;}
        .btn-certificado { background-color:#3498db;}
        .btn-especializado { background-color:#9b59b6;}
        .btn-social { background-color:#34495e; margin-bottom:20px; }

        .btn-carta:hover { background-color:#f39c12; }
        .btn-receta:hover { background-color:#2ecc71; }
        .btn-certificado:hover { background-color:#2980b9; }
        .btn-especializado:hover { background-color:#8e44ad; }
        .btn-social:hover { background-color:#2c3e50; }

        .form-section { display:none; }
        #btn-go-admin { width:100%; background-color:#2c3e50; color:white; padding:10px; margin-top:20px; border:none; border-radius:5px; cursor:pointer; font-size:1em; transition: background-color 0.3s; }
        #btn-go-admin:hover { background-color:#1f2a36; }

        .status-page { text-align:center; padding:50px; background-color:#fff; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); min-height:250px; display:flex; flex-direction:column; justify-content:center; }
        .status-page .spinner { border:5px solid #f3f3f3; border-top:5px solid #3498db; border-radius:50%; width:50px; height:50px; animation: spin 2s linear infinite; margin:20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-download-now { background-color:#27ae60; margin-top:20px; width:50%; margin:20px auto; }

        .payment-notice { background-color:#eaf7ff; color:#2980b9; padding:10px; border:1px solid #3498db; border-radius:4px; margin-bottom:15px; text-align:center; font-weight:bold; font-size:0.95em; }
        .disclaimer-notice { background-color:#fcebeb; color:#c0392b; padding:10px; border:1px solid #c0392b; border-radius:4px; margin-bottom:20px; text-align:center; font-weight:bold; font-size:0.85em; }

        .whatsapp-float { position:fixed; width:60px; height:60px; bottom:40px; left:20px; background-color:#25d366; color:#fff; border-radius:50px; text-align:center; font-size:30px; box-shadow:2px 2px 3px #999; z-index:100; display:flex; align-items:center; justify-content:center; text-decoration:none;}
        .whatsapp-float:hover { background-color:#128c7e; }

        .fixed-payment-info { position:fixed; bottom:0; right:0; background-color:#34495e; color:white; padding:10px 15px; border-top-left-radius:8px; font-size:0.85em; z-index:99; text-align:right; max-width:350px; }
        .fixed-payment-info strong { color:#f1c40f; }
        .fixed-payment-info p { margin:2px 0; }

        .request-item { border:1px solid #ccc; padding:10px; margin-bottom:10px; background-color:#fff; display:flex; justify-content:space-between; align-items:center; }
        .request-actions button { width:auto; padding:8px 12px; font-size:0.9em; margin-left:10px; }
        .btn-authorize { background-color:#3498db; color:#fff; border:none; padding:8px 10px; border-radius:4px; cursor:pointer; }
        .btn-reject { background-color:#c0392b; color:#fff; border:none; padding:8px 10px; border-radius:4px; cursor:pointer; }
        .download-link-box { background-color:#f0f0f0; border:1px dashed #3498db; padding:10px; margin-top:10px; word-break:break-all; font-size:0.9em; }

        /* peque√±o ajuste para inputs de archivos */
        input[type="file"] { padding:6px 10px; }
    </style>
</head>
<body>

    <h1>üìù Generador de Documentos y Solicitudes</h1>

    <div class="disclaimer-notice">
        *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
    </div>

    <div id="app-container">

        <div id="main-menu">
            <h2>üåê Acceso a Grupo y Soporte</h2>
            <button class="btn-menu btn-social" onclick="showForm('whatsapp_group')">
                <i class="fab fa-whatsapp"></i> Unirse a nuestro Grupo de WhatsApp
            </button>

            <h2>‚úâÔ∏è Cartas de Recomendaci√≥n</h2>
            <button class="btn-menu btn-carta" onclick="showForm('laboral')">Carta de Recomendaci√≥n LABORAL</button>
            <button class="btn-menu btn-carta" onclick="showForm('personal')">Carta de Recomendaci√≥n PERSONAL</button>

            <h2>üíä Documentos M√©dicos y Recetas</h2>
            <button class="btn-menu btn-receta" onclick="showForm('incapacidad_imss')">Incapacidad IMSS</button>
            <button class="btn-menu btn-receta" onclick="showForm('receta_similares')">Receta M√©dica SIMILARES</button>
            <button class="btn-menu btn-receta" onclick="showForm('receta_ahorro')">Receta M√©dica DEL AHORRO</button>
            <button class="btn-menu btn-receta" onclick="showForm('receta_imss')">Receta M√©dica IMSS</button>

            <h2>üéì Certificados de Estudios</h2>
            <button class="btn-menu btn-certificado" onclick="showForm('cert_primaria')">Certificado de PRIMARIA</button>
            <button class="btn-menu btn-certificado" onclick="showForm('cert_secundaria')">Certificado de SECUNDARIA</button>
            <button class="btn-menu btn-certificado" onclick="showForm('cert_prepa')">Certificado de PREPARATORIA</button>

            <h2>‚≠ê Servicios Especializados</h2>
            <button class="btn-menu btn-especializado" onclick="showForm('metodo_shein')">Metodo Shein</button>
            <button class="btn-menu btn-especializado" onclick="showForm('metodo_cinepolis')">Metodo Cin√©polis</button>
            <button class="btn-menu btn-especializado" onclick="showForm('metodo_temu')">Metodo TEMU</button>
            <button class="btn-menu btn-especializado" onclick="showForm('cv_desde_cero')">CV DESDE CERO</button>
            <button class="btn-menu btn-especializado" onclick="showForm('sellos_personales')">‚úçÔ∏è SELLOS PERSONALES</button>
            <button class="btn-menu btn-especializado" onclick="showForm('formato_solicitud_pdf')">üßë‚Äçüîß FORMATO DE SOLICITUD EN PDF</button>

            <button id="btn-go-admin" onclick="showForm('admin_login')">Acceso de Administrador</button>
        </div>

        <!-- ADMIN LOGIN -->
        <div id="admin-login" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <h2>üîí Acceso del Administrador</h2>
            <p>Ingrese sus credenciales para autorizar las solicitudes.</p>
            <div class="input-group">
                <label for="adminUser">Usuario:</label>
                <input type="text" id="adminUser" placeholder="Ingrese su usuario" value="trollgaga999@gmail.com">
                <label for="adminPass">Contrase√±a:</label>
                <input type="password" id="adminPass" placeholder="Ingrese su contrase√±a" value="Johan207">
                <button class="btn-action" style="background-color:#2c3e50;" onclick="authenticateAdmin()">Iniciar Sesi√≥n</button>
            </div>
        </div>

        <!-- ADMIN DASHBOARD -->
        <div id="admin-dashboard" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Cerrar Sesi√≥n</button>
            <h2>‚öôÔ∏è Panel de Autorizaci√≥n de Solicitudes</h2>
            <p>Al autorizar, el cliente ver√° autom√°ticamente el bot√≥n de descarga en su p√°gina de espera.</p>

            <h3>Solicitudes Pendientes:</h3>
            <div id="pending-requests-list" class="input-group">
                <p id="no-requests-msg">No hay solicitudes pendientes en el almacenamiento local de este navegador.</p>
            </div>
        </div>

        <!-- FORM: Receta Similares -->
        <div id="form-receta_similares" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>

            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>

            <h2>üíä Formulario de Receta M√©dica SIMILARES</h2>
            <div class="input-group">
                <h2>üë®‚Äç‚öïÔ∏è Datos del M√©dico y Emisi√≥n</h2>
                <label for="doctorNombreSimilares">Nombre del M√©dico (Ej: Dr. DUARTE ABDALA MARIO RAFAEL):</label>
                <input type="text" id="doctorNombreSimilares" value="DR. ROGER GUITIERREZ SALAZAR">

                <label for="cedulaSimilares">C√©dula Profesional / Prof. / Especialidad:</label>
                <input type="text" id="cedulaSimilares" value="MEDICO CIRUJANO  CED. PROF. 98569946">

                <label for="direccionSimilares">Direcci√≥n del Consultorio (Ej: AV. PDTE...):</label>
                <input type="text" id="direccionSimilares" value="#30 av. Luis Donaldo Colosio">

                <label for="ciudadSimilares">Ciudad (Ej: CIUDAD DE M√âXICO):</label>
                <input type="text" id="ciudadSimilares" value="CIUDAD DE M√âXICO">

                <label for="fechaEmisionSimilares">Fecha de Emisi√≥n de la Receta:</label>
                <input type="date" id="fechaEmisionSimilares" value="">
                
                <label for="logoInputSimilares">Insertar Logo de la Instituci√≥n/Receta (Opcional):</label>
                <input type="file" id="logoInputSimilares" accept="image/*">
            </div>

            <div class="input-group">
                <h2>üë§ Datos del Paciente</h2>
                <label for="nombrePacienteSimilares">Nombre(s) del Paciente:</label>
                <input type="text" id="nombrePacienteSimilares" value="CRISTOPHER ORLANDO RAMIREZ">

                <div class="date-container">
                    <div>
                        <label for="apellidoPSimilares">Apellido Paterno:</label>
                        <input type="text" id="apellidoPSimilares" value="RAMIREZ">
                    </div>
                    <div>
                        <label for="apellidoMSimilares">Apellido Materno:</label>
                        <input type="text" id="apellidoMSimilares" value="">
                    </div>
                </div>

                <div class="date-container">
                    <div>
                        <label for="sexoSimilares">Sexo (Ej: MASCULINO):</label>
                        <input type="text" id="sexoSimilares" value="MASCULINO">
                    </div>
                    <div>
                        <label for="edadSimilares">Edad:</label>
                        <input type="text" id="edadSimilares" value="6 A√ëOS">
                    </div>
                </div>

                <label for="fechaNacSimilares">Fecha de Nacimiento (Para la receta):</label>
                <input type="date" id="fechaNacSimilares" value="2019-07-18">

                <label for="alergiasSimilares">Alergias (Ej: NEGADAS):</label>
                <input type="text" id="alergiasSimilares" value="NEGADAS">
            </div>

            <div class="input-group">
                <h2>üìà Signos Vitales y Medidas</h2>
                <div class="date-container">
                    <div>
                        <label for="spo2Similares">T.A. (Ej: 100/72MM/Hg):</label>
                        <input type="text" id="spo2Similares" value="100/72MM/Hg">
                    </div>
                    <div>
                        <label for="fcSimilares">TEMP (Ej: 36.5¬∞):</label>
                        <input type="text" id="fcSimilares" value="36.5¬∞">
                    </div>
                </div>
                <div class="date-container">
                    <div>
                        <label for="frSimilares">F.C X MIN:</label>
                        <input type="text" id="frSimilares" value="73 xmin">
                    </div>
                    <div>
                        <label for="tempSimilares">PESO (Ej: 25KG):</label>
                        <input type="text" id="tempSimilares" value="25KG">
                    </div>
                </div>
                <div class="date-container">
                    <div>
                        <label for="pesoSimilares">F.R X MIN:</label>
                        <input type="text" id="pesoSimilares" value="20 xmin">
                    </div>
                    <div>
                        <label for="tallaSimilares">TALLA:</label>
                        <input type="text" id="tallaSimilares" value="6">
                    </div>
                </div>
                <label for="dxSimilares">Diagn√≥stico/Motivo de Consulta:</label>
                <input type="text" id="dxSimilares" value="INSOLACI√ìN Y DOLOR ESTOMACAL">
            </div>

            <div class="input-group">
                <h2>üìù Contenido de la Receta</h2>
                <label for="contenidoConsultaSimilares">Contenido de la Consulta (Texto):</label>
                <textarea id="contenidoConsultaSimilares">Paciente acude a consulta m√©dica con dolor abdominal, diarrea con episodios agudos y malestar general. Sin presentar fiebre.</textarea>

                <label for="tratamientoSimilares">TRATAMIENTO (Una l√≠nea por medicamento):</label>
                <textarea id="tratamientoSimilares">1.- AMBROXOL 3.2GR/100ML JARABE 120 ML
1 CD 12 HRS DURANTE 7D ORAL
2.- PARACETAMOL 40MG/1ML SUSPENSION 15 ML
1 CD 12 HRS DURANTE 5D ORAL</textarea>

                <label for="indicacionesGeneralesSimilares">Indicaciones Generales:</label>
                <textarea id="indicacionesGeneralesSimilares">Reposo m√≠nimo de 2-3 d√≠as</textarea>

                <label for="proximaCitaSimilares">Pr√≥xima Cita (Fecha):</label>
                <input type="text" id="proximaCitaSimilares" value="27/03/2021">
                
                <label for="firmaInputSimilares">Firma del M√©dico (Opcional, NO colocada autom√°ticamente si la sube):</label>
                <input type="file" id="firmaInputSimilares" accept="image/*">
            </div>

            <button class="btn-action" onclick="saveSolicitud('receta_similares')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
        </div>

        <!-- Otros formularios placeholder (mantener estructura, no se muestran) -->
        <div id="form-incapacidad_imss" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">*NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO*</div>
            <div class="payment-notice">*PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*</div>
            <h2>üíä Formulario de Incapacidad IMSS</h2>
            <div class="input-group">
                <p>‚ö†Ô∏è **FORMULARIO PENDIENTE:** Agregue los campos espec√≠ficos para la Incapacidad IMSS aqu√≠.</p>
                <label for="placeholder1_incapacidad">Ejemplo de Campo (a borrar):</label>
                <input type="text" id="placeholder1_incapacidad" value="">
            </div>
            <button class="btn-action" onclick="saveSolicitud('incapacidad_imss')">üíæ Guardar Solicitud</button>
        </div>

        <!-- M√°s formularios de ejemplo (omitidos por brevedad) -->
    </div>

    <div id="status-page" class="status-page" style="display:none;">
        <div class="disclaimer-notice">*NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*</div>
    </div>

    <a href="https://wa.me/message/AZLK65CETSPQL1" class="whatsapp-float" target="_blank" title="Soporte WhatsApp">
        <i class="fab fa-whatsapp"></i>
    </a>

    <div class="fixed-payment-info">
        <p>‚ö†Ô∏è **PAGO**</p>
        <p>*PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*</p>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        const STORAGE_KEY = 'pending_requests_list';
        const APPROVED_KEY = 'approved_requests_list';

        // --- ADMIN CREDENCIALES ---
        const ADMIN_USER = 'trollgaga999@gmail.com';
        const ADMIN_PASS = 'Johan207';

        let statusCheckInterval = null;

        function getBaseUrl() {
            return window.location.href.split('#')[0];
        }

        // Manejo de vistas
        const viewIdMap = {
            'menu': 'main-menu',
            'laboral': 'form-laboral',
            'personal': 'form-personal',
            'admin_login': 'admin-login',
            'admin_dashboard': 'admin-dashboard',
            'incapacidad_imss': 'form-incapacidad_imss',
            'receta_similares': 'form-receta_similares',
            'receta_ahorro': 'form-receta_ahorro',
            'receta_imss': 'form-receta_imss',
            'cert_primaria': 'form-cert_primaria',
            'cert_secundaria': 'form-cert_secundaria',
            'cert_prepa': 'form-cert_prepa',
            'metodo_shein': 'form-metodo_shein',
            'metodo_cinepolis': 'form-metodo_cinepolis',
            'metodo_temu': 'form-metodo_temu',
            'cv_desde_cero': 'form-cv_desde_cero',
            'sellos_personales': 'form-sellos_personales',
            'formato_solicitud_pdf': 'formato_solicitud_pdf'
        };

        function showForm(viewId, pushHistory = true) {
            const sections = Object.values(viewIdMap);
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            const targetId = viewIdMap[viewId] || viewId;
            const viewElement = document.getElementById(targetId);

            if (viewId === 'whatsapp_group') {
                window.open('https://chat.whatsapp.com/GbkvIbPwCRX1JacpJJOS9D', '_blank');
                return;
            }

            if (viewElement) {
                viewElement.style.display = 'block';
                window.scrollTo(0, 0);
                if (pushHistory) {
                    let url = getBaseUrl();
                    let state = { viewId: viewId };
                    if (viewId !== 'menu') { url += `#${viewId}`; } else { url = getBaseUrl(); }
                    history.pushState(state, '', url);
                }
            }
        }

        window.addEventListener('popstate', (e) => {
            const state = history.state;
            if (!state) { showForm('menu', false); return; }
            showForm(state.viewId || 'menu', false);
        });

        function authenticateAdmin() {
            const user = document.getElementById('adminUser').value;
            const pass = document.getElementById('adminPass').value;
            if (user === ADMIN_USER && pass === ADMIN_PASS) {
                alert("¬°Bienvenido, Administrador! Accediendo al Panel de Autorizaci√≥n.");
                showForm('admin_dashboard');
                loadPendingRequests();
            } else {
                alert("Usuario o Contrase√±a incorrectos. Int√©ntalo de nuevo.");
            }
        }

        function getRequests(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }
        function saveRequests(key, requests) {
            localStorage.setItem(key, JSON.stringify(requests));
        }

        async function saveSolicitud(tipoCarta) {
            let nombreSolicitante = 'Cliente', nombreAsunto = tipoCarta.toUpperCase(), pdfBase64 = null;

            if (tipoCarta === 'receta_similares') {
                nombreSolicitante = document.getElementById('nombrePacienteSimilares').value || 'Paciente';
                nombreAsunto = nombreSolicitante;
                pdfBase64 = await generarPDFRecetaSimilares(false);
            } else {
                // Placeholder para otros tipos
                pdfBase64 = "BASE64_PLACEHOLDER_FOR_NEW_TYPE";
            }

            if (!pdfBase64) {
                alert(`Error al generar el documento ${tipoCarta}. Por favor, revise los campos.`);
                return;
            }

            if (pdfBase64 === "BASE64_PLACEHOLDER_FOR_NEW_TYPE") {
                alert(`AVISO: Se ha guardado la solicitud ${tipoCarta} con datos de PRUEBA. El administrador proceder√° a la autorizaci√≥n.`);
            }

            const requestId = Date.now().toString();
            const newRequest = {
                id: requestId,
                type: tipoCarta,
                name: nombreAsunto,
                requesterName: nombreSolicitante,
                pdfBase64: pdfBase64,
                status: 'pending',
                timestamp: new Date().toLocaleString()
            };

            const requests = getRequests(STORAGE_KEY);
            requests.push(newRequest);
            saveRequests(STORAGE_KEY, requests);

            const url = `${getBaseUrl()}#status?id=${requestId}`;
            const state = { viewId: 'status', requestId: requestId };
            history.pushState(state, '', url);
            checkURL();
        }

        // Estado y pagina de espera
        function checkURL() {
            if (statusCheckInterval) { clearInterval(statusCheckInterval); statusCheckInterval = null; }
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash.split('?')[1] || '');
            const requestId = params.get('id');
            if (hash.startsWith('status') && requestId) {
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('status-page').style.display = 'flex';
                document.getElementById('status-page').innerHTML = '<div class="disclaimer-notice">*NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*</div>';
                checkStatus(requestId);
                statusCheckInterval = setInterval(() => checkStatus(requestId), 5000);
                return;
            }
            showForm('menu', false);
        }

        function checkStatus(requestId) {
            const approvedRequests = getRequests(APPROVED_KEY);
            const request = approvedRequests.find(req => req.id === requestId);
            const statusPage = document.getElementById('status-page');
            const disclaimer = statusPage.querySelector('.disclaimer-notice') ? statusPage.querySelector('.disclaimer-notice').outerHTML : '';
            if (!request) {
                statusPage.innerHTML = disclaimer + `
                    <h2>‚è≥ Solicitud Enviada - Esperando Autorizaci√≥n</h2>
                    <div class="spinner"></div>
                    <p>Su solicitud de <strong>${requestId}</strong> ha sido recibida.</p>
                    <p>Estamos esperando que el administrador la apruebe una vez realizado el pago.</p>
                    <p style="font-size:0.8em;color:#555;">(Esta p√°gina se actualizar√° autom√°ticamente cada 5 segundos)</p>
                    <p style="margin-top:20px;">Puede guardar este enlace: <code>${getBaseUrl()}#status?id=${requestId}</code></p>
                `;
            } else {
                if (statusCheckInterval) { clearInterval(statusCheckInterval); statusCheckInterval = null; }
                statusPage.innerHTML = disclaimer + `
                    <h2>‚úÖ ¬°Solicitud Aprobada!</h2>
                    <p>El administrador ha autorizado su documento para <strong>${request.name}</strong>.</p>
                    <button class="btn-action btn-download-now" onclick="triggerDownload('${request.id}')"> Descargar Documento Ahora </button>
                    <p style="margin-top:30px;"><a href="#" onclick="showForm('menu')">‚Üê Volver al Men√∫ Principal</a></p>
                `;
            }
        }

        function triggerDownload(requestId) {
            const approvedRequests = getRequests(APPROVED_KEY);
            const request = approvedRequests.find(req => req.id === requestId);
            if (!request) {
                alert("Error: Archivo no encontrado.");
                showForm('menu');
                return;
            }
            if (request.pdfBase64 === "BASE64_PLACEHOLDER_FOR_NEW_TYPE") {
                alert("Este es un documento placeholder de PRUEBA. No se puede descargar un PDF real.");
                return;
            }
            const pdfBase64 = request.pdfBase64;
            const name = request.name.toUpperCase().replace(/\s/g, '_');
            const type = request.type.toUpperCase().replace(/_/g, '-');
            const link = document.createElement('a');
            link.href = `data:application/pdf;base64,${pdfBase64}`;
            link.download = `Documento_Aprobado_${name}_${type}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            const statusPage = document.getElementById('status-page');
            const disclaimer = statusPage.querySelector('.disclaimer-notice') ? statusPage.querySelector('.disclaimer-notice').outerHTML : '';
            statusPage.innerHTML = disclaimer + `
                <div>
                    <h1>‚úÖ Descarga Exitosa</h1>
                    <p>Su documento para <strong>${request.name}</strong> ha sido descargado. Por favor, revise su carpeta de descargas.</p>
                    <p style="margin-top:30px;"><a href="#" onclick="showForm('menu')">‚Üê Volver al Men√∫ Principal</a></p>
                </div>
            `;
        }

        function loadPendingRequests() {
            const requests = getRequests(STORAGE_KEY).filter(req => req.status === 'pending');
            const listElement = document.getElementById('pending-requests-list');
            listElement.innerHTML = '';
            if (requests.length === 0) {
                listElement.innerHTML = '<p id="no-requests-msg">No hay solicitudes pendientes en el almacenamiento local de este navegador.</p>';
                return;
            }
            requests.forEach(req => {
                const typeDisplay = req.type.replace(/_/g, ' ').toUpperCase();
                const item = document.createElement('div');
                item.id = `request-${req.id}`;
                item.className = 'request-item';
                item.innerHTML = `
                    <div class="request-info">
                        <strong>${typeDisplay} - ${req.name}</strong>
                        <p>Solicitante: ${req.requesterName} (ID: ${req.id})</p>
                        <p style="font-size:0.8em;">URL del Cliente: <code style="word-break: break-all;">${getBaseUrl()}#status?id=${req.id}</code></p>
                    </div>
                    <div class="request-actions">
                        <button class="btn-authorize" onclick="authorizeRequest('${req.id}')">Autorizar</button>
                        <button class="btn-reject" onclick="deleteRequest('${req.id}', '${STORAGE_KEY}')">Rechazar</button>
                    </div>
                `;
                listElement.appendChild(item);
            });
        }

        function authorizeRequest(requestId) {
            let pendingRequests = getRequests(STORAGE_KEY);
            const index = pendingRequests.findIndex(req => req.id === requestId);
            if (index === -1) {
                alert("Error: Solicitud no encontrada.");
                loadPendingRequests();
                return;
            }
            const request = pendingRequests[index];
            request.status = 'approved';
            const approvedRequests = getRequests(APPROVED_KEY);
            approvedRequests.push(request);
            saveRequests(APPROVED_KEY, approvedRequests);
            pendingRequests.splice(index, 1);
            saveRequests(STORAGE_KEY, pendingRequests);
            alert(`¬°Solicitud Autorizada! El cliente ahora puede descargar el archivo usando el enlace de su p√°gina de estatus.`);
            loadPendingRequests();
        }

        function deleteRequest(requestId, key) {
            const confirmMsg = key === STORAGE_KEY ? "¬øEst√° seguro de rechazar y eliminar esta solicitud pendiente?" : "¬øEst√° seguro de eliminar esta solicitud APROBADA del historial del administrador?";
            if (!confirm(confirmMsg)) return;
            let requests = getRequests(key);
            const index = requests.findIndex(req => req.id === requestId);
            if (index > -1) {
                requests.splice(index, 1);
                saveRequests(key, requests);
            }
            loadPendingRequests();
        }

        /* ---------------------------
           UTILIDADES PARA PDF / IMAGENES
           --------------------------- */
        function drawJustifiedText(doc, text, x, y, maxWidth, lineHeight) {
            let currentY = y;
            const splitText = doc.splitTextToSize(text, maxWidth);
            splitText.forEach((line, index) => {
                if (index < splitText.length - 1) {
                    doc.text(line, x, currentY, { align: 'justify' });
                } else {
                    doc.text(line, x, currentY);
                }
                currentY += lineHeight;
            });
            return currentY;
        }

        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => resolve(null);
        });

        // Genera un n√∫mero aleatorio tipo expediente (10 d√≠gitos)
        function generarNumeroAleatorio() {
            let num = '';
            for (let i=0;i<10;i++) num += Math.floor(Math.random()*10).toString();
            return num;
        }

        // Dibuja un "barcode estilizado" con barras (suficiente para apariencia)
        function drawBarcodeStyled(doc, x, y, width, height, code) {
            // unit width en base al n√∫mero de barras deseadas
            // convertimos cada d√≠gito en una secuencia de barras (simplificado)
            const digits = code.split('');
            const totalParts = digits.length * 4; // 4 partes por d√≠gito -> variaci√≥n
            const unit = width / totalParts;
            let cursor = x;
            for (let i = 0; i < digits.length; i++) {
                const d = parseInt(digits[i], 10);
                // Secuencia de 4: alternating (narrow/wide) influenciada por el d√≠gito
                const pattern = [
                    1 + (d % 3), // ancho 1..3
                    1 + ((d + 1) % 3),
                    1 + ((d + 2) % 3),
                    1 + ((d + 1) % 2)
                ];
                for (let p = 0; p < pattern.length; p++) {
                    const w = Math.max(1, Math.round(unit * pattern[p]));
                    // Dibujar barra negra en posiciones pares (para crear contraste)
                    if (p % 2 === 0) {
                        doc.rect(cursor, y, w, height, 'F'); // Fill
                    }
                    cursor += w;
                }
            }
            // Texto del c√≥digo debajo
            doc.setFontSize(8);
            doc.text(code, x + (width / 2), y + height + 4, { align: 'center' });
        }

        // Logo por defecto (Farmacias Similares - dise√±o simple SVG embebido en base64)
        const DEFAULT_LOGO_DATAURL = 'data:image/svg+xml;base64,' + btoa(
            `<svg xmlns="http://www.w3.org/2000/svg" width="200" height="80" viewBox="0 0 200 80">
                <rect width="200" height="80" fill="white"/>
                <g transform="translate(10,8)">
                  <circle cx="24" cy="24" r="24" fill="#0a6ebd"/>
                  <path d="M18 24 C18 14 36 12 36 24 C36 36 18 34 18 24 Z" fill="white"/>
                  <text x="62" y="36" font-family="Arial" font-size="14" fill="#0a6ebd">FARMACIAS</text>
                  <text x="62" y="53" font-family="Arial" font-size="14" fill="#0a6ebd">SIMILARES</text>
                </g>
            </svg>`
        );

        /* ---------------------------
           FUNCI√ìN PDF: RECETA SIMILARES
           --------------------------- */
        async function generarPDFRecetaSimilares(descargar = true) {
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 10;
            let y = 10;
            const lineHeight = 6;

            // Recuperar datos del formulario
            const nombreDoc = (document.getElementById('doctorNombreSimilares').value || '').toUpperCase();
            const cedula = (document.getElementById('cedulaSimilares').value || '').toUpperCase();
            const direccion = (document.getElementById('direccionSimilares').value || '').toUpperCase();
            const ciudad = (document.getElementById('ciudadSimilares').value || '').toUpperCase();
            const fechaEmisionVal = document.getElementById('fechaEmisionSimilares').value;
            const fechaEmision = fechaEmisionVal ? new Date(fechaEmisionVal).toLocaleDateString('es-ES') : new Date().toLocaleDateString('es-ES');
            const nombreP = (document.getElementById('nombrePacienteSimilares').value || '').toUpperCase();
            const apellidoP = (document.getElementById('apellidoPSimilares').value || '').toUpperCase();
            const apellidoM = (document.getElementById('apellidoMSimilares').value || '').toUpperCase();
            const sexo = (document.getElementById('sexoSimilares').value || '').toUpperCase();
            const edad = (document.getElementById('edadSimilares').value || '').toUpperCase();
            const fechaNacVal = document.getElementById('fechaNacSimilares').value;
            const fechaNac = fechaNacVal ? new Date(fechaNacVal).toLocaleDateString('es-ES') : '';
            const alergias = (document.getElementById('alergiasSimilares').value || '').toUpperCase();

            const ta = (document.getElementById('spo2Similares').value || '').toUpperCase();
            const temp = (document.getElementById('fcSimilares').value || '').toUpperCase();
            const fc = (document.getElementById('frSimilares').value || '').toUpperCase();
            const peso = (document.getElementById('pesoSimilares').value || '').toUpperCase();
            const talla = (document.getElementById('tallaSimilares').value || '').toUpperCase();
            const dx = (document.getElementById('dxSimilares').value || '').toUpperCase();

            const contenido = document.getElementById('contenidoConsultaSimilares').value || '';
            const tratamiento = document.getElementById('tratamientoSimilares').value || '';
            const indicaciones = document.getElementById('indicacionesGeneralesSimilares').value || '';
            const proxima = document.getElementById('proximaCitaSimilares').value || '';

            // Cargar logo (subido por el usuario) si existe, si no, usar DEFAULT_LOGO_DATAURL
            const logoFile = document.getElementById('logoInputSimilares').files[0];
            const logoBase64 = logoFile ? await fileToBase64(logoFile) : DEFAULT_LOGO_DATAURL;

            // Generar n√∫mero aleatorio y dibujar c√≥digo de barras
            const barcodeNumber = generarNumeroAleatorio();

            // --- Encabezado: logo a la izquierda ---
            const logoW = 34; // mm
            const logoH = 20; // mm
            doc.addImage(logoBase64, 'PNG', margin, y, logoW, logoH);

            // --- Encabezado: nombre del m√©dico centrado alto ---
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(nombreDoc, pageWidth/2, y + 8, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(cedula, pageWidth/2, y + 13, { align: 'center' });
            doc.text('UNIVERSIDAD NACIONAL AUTONOMA DE MEXICO', pageWidth/2, y + 18, { align: 'center' });

            // --- C√≥digo de barras en la esquina superior derecha ---
            const barcodeW = 70;
            const barcodeH = 18;
            const barcodeX = pageWidth - margin - barcodeW;
            const barcodeY = y + 2;
            drawBarcodeStyled(doc, barcodeX, barcodeY, barcodeW, barcodeH, barcodeNumber);

            y += Math.max(logoH, 22) + 2;

            // L√≠nea separadora horizontal
            doc.setDrawColor(0);
            doc.setLineWidth(0.4);
            doc.line(margin, y, pageWidth - margin, y);
            y += 6;

            // --- Datos paciente (alineados en dos columnas) ---
            const colLeftX = margin;
            const colRightX = pageWidth/2 + 5;
            const fieldGapY = 6;

            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text(`NOMBRE:`, colLeftX, y);
            doc.setFont(undefined, 'normal');
            doc.text(`${nombreP} ${apellidoP} ${apellidoM}`, colLeftX + 20, y);

            doc.setFont(undefined, 'bold');
            doc.text(`NUMERO DE EXPEDIENTE:`, colRightX, y);
            doc.setFont(undefined, 'normal');
            doc.text(barcodeNumber, colRightX + 40, y);
            y += fieldGapY;

            doc.setFont(undefined, 'bold');
            doc.text(`SEXO:`, colLeftX, y);
            doc.setFont(undefined, 'normal');
            doc.text(sexo, colLeftX + 18, y);

            doc.setFont(undefined, 'bold');
            doc.text(`EDAD:`, colRightX, y);
            doc.setFont(undefined, 'normal');
            doc.text(edad, colRightX + 18, y);
            y += fieldGapY;

            doc.setFont(undefined, 'bold');
            doc.text(`FECHA DE NACIMIENTO:`, colLeftX, y);
            doc.setFont(undefined, 'normal');
            doc.text(fechaNac, colLeftX + 42, y);

            doc.setFont(undefined, 'bold');
            doc.text(`FECHA Y HORA DE ELABORACION:`, colRightX, y);
            doc.setFont(undefined, 'normal');
            doc.text(fechaEmision, colRightX + 48, y);
            y += fieldGapY + 2;

            // L√≠nea separadora
            doc.setLineWidth(0.3);
            doc.line(margin, y, pageWidth - margin, y);
            y += 6;

            // --- Signos y Diagn√≥stico (dos columnas: izquierda signos, derecha tratamiento) ---
            const leftColW = (pageWidth - margin*2) * 0.52;
            const rightColX = margin + leftColW + 6;
            const rightColW = pageWidth - margin - rightColX;

            // Izquierda (signos)
            doc.setFont(undefined, 'bold');
            doc.text('T.A.', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(ta, margin + 18, y);

            doc.setFont(undefined, 'bold');
            doc.text('TEMP:', margin + 60, y);
            doc.setFont(undefined, 'normal');
            doc.text(temp, margin + 84, y);
            y += lineHeight;

            doc.setFont(undefined, 'bold');
            doc.text('F.C X MIN', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(fc, margin + 24, y);

            doc.setFont(undefined, 'bold');
            doc.text('PESO:', margin + 60, y);
            doc.setFont(undefined, 'normal');
            doc.text(peso, margin + 80, y);
            y += lineHeight;

            doc.setFont(undefined, 'bold');
            doc.text('F.R X MIN', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text('-', margin + 34, y);

            doc.setFont(undefined, 'bold');
            doc.text('TALLA:', margin + 60, y);
            doc.setFont(undefined, 'normal');
            doc.text(talla, margin + 90, y);
            y += lineHeight + 4;

            // Diagn√≥stico
            doc.setFont(undefined, 'bold');
            doc.text('I.D', margin, y);
            doc.setFont(undefined, 'normal');
            // Si es largo, justificar
            const dxY = drawJustifiedText(doc, dx, margin + 10, y, leftColW - 20, 5);
            // Ajustar y al final de la columna de la izquierda
            let leftColumnBottom = dxY + 2;

            // Derecha (tratamiento)
            doc.setFont(undefined, 'bold');
            doc.text('TRATAMIENTO:', rightColX, y - lineHeight); // encabezado ligeramente m√°s arriba
            doc.setFont(undefined, 'normal');
            const tratamientoY = drawJustifiedText(doc, tratamiento, rightColX, y, rightColW - 6, 5);
            let rightColumnBottom = tratamientoY + 2;

            // Calcular el y m√°ximo entre columnas
            y = Math.max(leftColumnBottom, rightColumnBottom);
            y += 6;

            // Observaciones / contenido de la consulta (ancho completo)
            doc.setFont(undefined, 'bold');
            doc.text('OBSERVACIONES', margin, y);
            y += 6;
            doc.setFont(undefined, 'normal');
            y = drawJustifiedText(doc, contenido + "\n\nINDICACIONES: " + indicaciones, margin, y, pageWidth - margin*2, 5);
            y += 6;

            // Pr√≥xima cita
            doc.setFont(undefined, 'bold');
            doc.text('PR√ìXIMA CITA:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(proxima, margin + 28, y);
            y += 12;

            // L√≠nea para firma y texto "COPIA FIRMA"
            const firmaX = pageWidth - margin - 70;
            doc.setLineWidth(0.4);
            doc.line(firmaX, y, firmaX + 60, y); // l√≠nea para firma
            doc.setFont(undefined, 'normal');
            doc.text('COPIA', firmaX - 40, y - 2);
            doc.setFont(undefined, 'bold');
            doc.text('FIRMA:', firmaX, y - 2);

            y += 18;

            // L√≠nea punteada inferior (como en la imagen)
            const dashY = doc.internal.pageSize.getHeight() - 28;
            const dashStartX = margin;
            const dashEndX = pageWidth - margin;
            const dashLen = 3;
            const gapLen = 3;
            let cursor = dashStartX;
            doc.setDrawColor(0);
            doc.setLineWidth(0.4);
            while (cursor < dashEndX) {
                doc.line(cursor, dashY, Math.min(cursor + dashLen, dashEndX), dashY);
                cursor += dashLen + gapLen;
            }

            // Si se desea descargar o retornar base64
            if (descargar) {
                // Generar nombre de archivo legible
                const safeName = (nombreP || 'PACIENTE').replace(/\s+/g, '_');
                doc.save(`Receta_${safeName}.pdf`);
                return true;
            } else {
                return doc.output('datauristring').split(',')[1];
            }
        }

        // Ejecutar checkURL al cargar
        window.addEventListener('load', () => {
            checkURL();
        });

    </script>
</body>
</html>

       
