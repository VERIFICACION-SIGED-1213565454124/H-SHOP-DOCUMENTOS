<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Documentos - Estatus de Solicitud</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Estilos generales */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 850px; 
            margin: 0 auto; 
            padding: 25px; 
            background-color: #f4f4f9; 
            position: relative; 
            padding-bottom: 100px; 
        }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 25px; }
        .input-group, .form-section { background-color: #ffffff; padding: 20px; margin-bottom: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-bottom: 15px; }
        label { display: block; margin-top: 10px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], textarea, input[type="file"], input[type="password"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .date-container { display: flex; justify-content: space-between; gap: 10px; }
        .date-container input { width: 100%; }
        textarea { height: 120px; resize: vertical; }
        
        /* Botones generales */
        .btn-action {
            background-color: #e67e22;
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        .btn-action:hover { background-color: #d35400; }
        .back-button { background-color: #95a5a6; width: auto; padding: 10px 15px; font-size: 1em; }

        /* Estilos de Botones de Men√∫ por Categor√≠a */
        .btn-menu {
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        .btn-carta { background-color: #f1c40f; } /* Amarillo para Cartas */
        .btn-receta { background-color: #27ae60; } /* Verde para Recetas/Documentos M√©dicos */
        .btn-certificado { background-color: #3498db; } /* Azul para Certificados */
        .btn-especializado { background-color: #9b59b6; } /* Morado para M√©todos/Otros Servicios */
        .btn-social { background-color: #34495e; margin-bottom: 20px; } /* Gris oscuro para Social */
        
        .btn-carta:hover { background-color: #f39c12; }
        .btn-receta:hover { background-color: #2ecc71; }
        .btn-certificado:hover { background-color: #2980b9; }
        .btn-especializado:hover { background-color: #8e44ad; }
        .btn-social:hover { background-color: #2c3e50; }

        .form-section { display: none; }
        
        /* Bot√≥n de admin discreto */
        #btn-go-admin {
            width: 100%;
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            margin-top: 10px; /* Ajustado */
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        #btn-go-admin:hover {
            background-color: #1f2a36;
        }
        
        /* Estilos de la p√°gina de estatus */
        .status-page {
            text-align: center; 
            padding: 50px; 
            background-color: #fff; 
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .status-page .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn-download-now {
            background-color: #27ae60;
            margin-top: 20px;
            width: 50%;
            margin: 20px auto;
        }
        
        /* Estilo para el nuevo aviso de pago */
        .payment-notice {
            background-color: #eaf7ff;
            color: #2980b9;
            padding: 10px;
            border: 1px solid #3498db;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 0.95em;
        }

        /* Estilo para el descargo de responsabilidad (Disclaimer) */
        .disclaimer-notice {
            background-color: #fcebeb;
            color: #c0392b;
            padding: 10px;
            border: 1px solid #c0392b;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 0.85em;
        }

        /* --- Elementos Flotantes (WhatsApp) y Fijos (Aviso de Pago Fijo) --- */
        
        /* Bot√≥n Flotante de WhatsApp */
        .whatsapp-float {
            position: fixed;
            width: 60px;
            height: 60px;
            bottom: 40px;
            left: 20px; 
            background-color: #25d366;
            color: #fff;
            border-radius: 50px;
            text-align: center;
            font-size: 30px;
            box-shadow: 2px 2px 3px #999;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }
        .whatsapp-float:hover {
            background-color: #128c7e;
        }

        /* Aviso de Pago Fijo (reemplaza a bank-info) */
        .fixed-payment-info {
            position: fixed;
            bottom: 0;
            right: 0; 
            background-color: #34495e;
            color: white;
            padding: 10px 15px;
            border-top-left-radius: 8px;
            font-size: 0.85em;
            z-index: 99;
            text-align: right;
            max-width: 350px;
        }
        .fixed-payment-info strong { color: #f1c40f; }
        .fixed-payment-info p { margin: 2px 0; }

        /* Estilos del panel de admin (Sin cambios) */
        .request-item {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .request-actions button {
            width: auto;
            padding: 8px 12px;
            font-size: 0.9em;
            margin-left: 10px;
        }
        .btn-authorize { background-color: #3498db; }
        .btn-reject { background-color: #c0392b; }
        .download-link-box {
            background-color: #f0f0f0;
            border: 1px dashed #3498db;
            padding: 10px;
            margin-top: 10px;
            word-break: break-all;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

    <h1>üìù Generador de Documentos y Solicitudes</h1>
    
    <div class="disclaimer-notice">
        *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
    </div>
    
    <div id="app-container">
    
        <div id="user-registration" class="form-section" style="display:block;"> 
            <button class="back-button" onclick="showForm('menu')">‚Üê Ir al Men√∫ Principal (si ya estoy registrado)</button>
            <h2>üìù Registro de Nuevo Cliente</h2>
            <p>Complete sus datos para crear su cuenta. Guarde su "ID de Cliente" generado, que necesitar√° para iniciar sesi√≥n.</p>
            <div class="input-group">
                <label for="regEmail">Correo Electr√≥nico:</label>
                <input type="text" id="regEmail" placeholder="ejemplo@correo.com">

                <label for="regPass">Contrase√±a:</label>
                <input type="password" id="regPass" placeholder="Ingrese su contrase√±a">
                
                <label for="regPassVerify">Verificar Contrase√±a:</label>
                <input type="password" id="regPassVerify" placeholder="Confirme su contrase√±a">

                <label for="regNombreCompleto">Nombre Completo:</label>
                <input type="text" id="regNombreCompleto" placeholder="Nombre(s) Apellido Paterno Apellido Materno">

                <label for="regFechaNac">Fecha de Nacimiento:</label>
                <input type="date" id="regFechaNac">
                
                <label for="regCurp">CURP:</label>
                <input type="text" id="regCurp" placeholder="Ingrese su CURP (18 caracteres)">

                <button class="btn-action" style="background-color: #3498db;" onclick="registerUser()">Registrarse</button>
                <p style="margin-top: 15px; text-align: center;">¬øYa tiene cuenta? <a href="#" onclick="showForm('user_login', true)">Iniciar Sesi√≥n</a></p>
                
                <button id="btn-go-admin-from-reg" class="btn-action" onclick="showForm('admin_login')" style="background-color: #2c3e50; margin-top: 20px; padding: 10px;">
                    Acceso de Administrador
                </button>
            </div>
            <div id="registration-success" style="display:none; padding: 15px; background-color: #e6ffe6; border: 1px solid #2ecc71; border-radius: 4px; margin-top: 20px;">
                <h3>‚úÖ ¬°Registro Exitoso!</h3>
                <p>Su cuenta ha sido creada. Por favor, guarde su **ID de Cliente** para iniciar sesi√≥n. Es su "usuario":</p>
                <p style="font-size: 1.2em; font-weight: bold; color: #27ae60;"><span id="generatedUserId"></span></p>
                <button class="btn-action back-button" onclick="showForm('user_login')">Ir a Iniciar Sesi√≥n</button>
            </div>
        </div>
        
        <div id="main-menu" class="form-section">
            
            <h2>üåê Acceso a Grupo y Soporte</h2>
            <button class="btn-menu btn-social" onclick="showForm('whatsapp_group')">
                <i class="fab fa-whatsapp"></i> Unirse a nuestro Grupo de WhatsApp
            </button>
            
            <h2>‚úâÔ∏è Cartas de Recomendaci√≥n</h2>
            <button class="btn-menu btn-carta" onclick="showForm('laboral')">Carta de Recomendaci√≥n LABORAL</button>
            <button class="btn-menu btn-carta" onclick="showForm('personal')">Carta de Recomendaci√≥n PERSONAL</button>
            
            <h2>üíä Documentos M√©dicos y Recetas</h2>
            <button class="btn-menu btn-receta" onclick="showForm('incapacidad_imss')">Incapacidad IMSS</button>
            <button class="btn-menu btn-receta" onclick="showForm('receta_similares')">Receta M√©dica SIMILARES</button>
            <button class="btn-menu btn-receta" onclick="showForm('receta_ahorro')">Receta M√©dica DEL AHORRO</button>
            <button class="btn-menu btn-receta" onclick="showForm('receta_imss')">Receta M√©dica IMSS</button>

            <h2>üéì Certificados de Estudios</h2>
            <button class="btn-menu btn-certificado" onclick="showForm('cert_primaria')">Certificado de PRIMARIA</button>
            <button class="btn-menu btn-certificado" onclick="showForm('cert_secundaria')">Certificado de SECUNDARIA</button>
            <button class="btn-menu btn-certificado" onclick="showForm('cert_prepa')">Certificado de PREPARATORIA</button>
            
            <h2>‚≠ê Servicios Especializados</h2>
            <button class="btn-menu btn-especializado" onclick="showForm('metodo_shein')">Metodo Shein</button>
            <button class="btn-menu btn-especializado" onclick="showForm('metodo_cinepolis')">Metodo Cin√©polis</button>
            <button class="btn-menu btn-especializado" onclick="showForm('metodo_temu')">Metodo TEMU</button>
            <button class="btn-menu btn-especializado" onclick="showForm('cv_desde_cero')">CV DESDE CERO</button>
            <button class="btn-menu btn-especializado" onclick="showForm('sellos_personales')">‚úçÔ∏è SELLOS PERSONALES</button>
            <button class="btn-menu btn-especializado" onclick="showForm('formato_solicitud_pdf')">üßë‚Äçüîß FORMATO DE SOLICITUD EN PDF</button>

            <h2>üîí Acceso de Clientes</h2>
            <button class="btn-action" style="background-color: #27ae60; margin-bottom: 5px;" onclick="showForm('user_login')">
                <i class="fas fa-user-circle"></i> Acceso de Clientes
            </button>
        </div>

        <div id="admin-login" class="form-section">
            <button class="back-button" onclick="showForm('user_registration')">‚Üê Volver al Registro</button>
            <h2>üîí Acceso del Administrador</h2>
            <p>Ingrese sus credenciales para autorizar las solicitudes.</p>
            
            <div class="input-group">
                <label for="adminUser">Usuario:</label>
                <input type="text" id="adminUser" placeholder="Ingrese su usuario">

                <label for="adminPass">Contrase√±a:</label>
                <input type="password" id="adminPass" placeholder="Ingrese su contrase√±a">
                
                <button class="btn-action" style="background-color: #2c3e50;" onclick="authenticateAdmin()">Iniciar Sesi√≥n</button>
            </div>
        </div>

        <div id="admin-dashboard" class="form-section">
            <button class="back-button" onclick="showForm('user_registration')">‚Üê Cerrar Sesi√≥n</button>
            <h2>‚öôÔ∏è Panel de Autorizaci√≥n de Solicitudes</h2>
            <p>Al autorizar, el cliente ver√° autom√°ticamente el bot√≥n de descarga en su p√°gina de espera.</p>

            <h3>Solicitudes Pendientes:</h3>
            <div id="pending-requests-list" class="input-group">
                <p id="no-requests-msg">No hay solicitudes pendientes en el almacenamiento local de este navegador.</p>
            </div>
        </div>
        
        <div id="user-login" class="form-section">
            <button class="back-button" onclick="showForm('user_registration')">‚Üê Volver al Registro</button>
            <h2>üë§ Acceso de Clientes</h2>
            <p>Ingrese su ID de Cliente y Contrase√±a para continuar.</p>
            
            <div class="input-group">
                <label for="clientUserId">ID de Cliente:</label>
                <input type="text" id="clientUserId" placeholder="Su ID de cliente generado">

                <label for="clientPass">Contrase√±a:</label>
                <input type="password" id="clientPass" placeholder="Su contrase√±a">
                
                <button class="btn-action" style="background-color: #27ae60;" onclick="authenticateUser()">Iniciar Sesi√≥n</button>
                <p style="margin-top: 15px; text-align: center;">¬øA√∫n no tiene cuenta? <a href="#" onclick="showForm('user_registration', true)">Registrarse Aqu√≠</a></p>
            </div>
            <div id="user-dashboard" style="display:none;">
                <h3>üëã Bienvenido(a), <span id="loggedInUserName">Cliente</span></h3>
                <p>Desde aqu√≠ podr√° ver el estado de sus solicitudes pendientes.</p>
                <button class="btn-action back-button" onclick="showForm('menu')">Ir al Men√∫ de Documentos</button>
                <button class="btn-action back-button" style="background-color: #e74c3c; margin-top: 10px;" onclick="logoutUser()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div id="form-laboral" class="form-section">
             <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
             <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>üíº Formulario de Carta Laboral</h2>
            <div class="input-group">
                <h2>üìù Datos de la Solicitud</h2>
                <label for="nombreSolicitanteLaboral">Tu Nombre Completo (Quien Pide la Carta):</label>
                <input type="text" id="nombreSolicitanteLaboral" value="Nombre del Solicitante">
                
                <label for="emailSolicitanteLaboral">Tu Correo Electr√≥nico (Solo para referencia):</label>
                <input type="text" id="emailSolicitanteLaboral" value="solicitante@ejemplo.com">
            </div>
            
            <div class="input-group">
                <h2>üìÇ Logo y Firma</h2>
                <label for="logoInputLaboral">Insertar Logo de la Empresa:</label>
                <input type="file" id="logoInputLaboral" accept="image/*">
                
                <label for="firmaInputLaboral">Insertar Firma:</label>
                <input type="file" id="firmaInputLaboral" accept="image/*">
            </div>
            <div class="input-group">
                <h2>üë§ Datos del Empleado</h2>
                <label for="fechaEmisionLaboral">Fecha de Emisi√≥n de la Carta:</label>
                <input type="date" id="fechaEmisionLaboral" value="2025-10-23"> <label for="nombreEmpleadoLaboral">Nombre Completo del Empleado:</label>
                <input type="text" id="nombreEmpleadoLaboral" value="JAIME LEONARDO GARCIA MENDEZ"> <label for="puestoDesempenadoLaboral">Puesto Desempe√±ado:</label>
                <input type="text" id="puestoDesempenadoLaboral" value="ANALISTA DE MANTENIMIENTO"> <div class="date-container">
                    <div>
                        <label for="fechaInicioLaboral">Fecha de Inicio Laboral:</label>
                        <input type="date" id="fechaInicioLaboral" value="2024-09-08"> </div>
                    <div>
                        <label for="fechaFinLaboral">Fecha de T√©rmino Laboral:</label>
                        <input type="date" id="fechaFinLaboral" value="2025-11-09"> </div>
                </div>
            </div>
            <div class="input-group">
                <h2>üìù Contenido de la Carta</h2>
                <label for="nombreEmpresaLaboral">Nombre de la Empresa:</label>
                <input type="text" id="nombreEmpresaLaboral" value="LARIMEX"> <label for="cuerpoPersonalidadLaboral">P√°rrafo de Personalidad y Habilidades:</label>
                <textarea id="cuerpoPersonalidadLaboral">Durante el tiempo que trabaj√≥ con nosotros, [nombre] demostr√≥ ser una persona responsable, proactiva y comprometida con su trabajo. Su disposici√≥n para aprender y colaborar fue excelente, adapt√°ndose de forma eficaz a las exigencias de los diferentes proyectos. Su desempe√±o siempre fue satisfactorio y su actitud de trabajo en equipo fue un gran aporte.</textarea>
                
                <label for="tareasLaboral">Tareas Principales (una por l√≠nea):</label>
                <textarea id="tareasLaboral">Preparaci√≥n de materiales: Ayud√≥ a organizar y preparar cemento, mezcla y otros materiales esenciales para las labores de construcci√≥n.
Asistencia en alba√±iler√≠a: Apoy√≥ a los maestros de obra en la preparaci√≥n y colocaci√≥n de ladrillos, bloques y otros elementos estructurales.
Mantenimiento del √°rea de trabajo: Colabor√≥ activamente en la limpieza y el orden de la obra, asegurando un ambiente de trabajo seguro y eficiente.
Traslado de equipo y herramientas: Ayud√≥ a mover y distribuir herramientas y equipo pesado, demostrando fuerza y precauci√≥n.</textarea>
                
                <label for="cuerpoCierreLaboral">P√°rrafo de Recomendaci√≥n y Cierre:</label>
                <textarea id="cuerpoCierreLaboral">Considero que [nombre] es un empleado valioso, con la capacidad y el deseo de crecer profesionalmente. Recomiendo su contrataci√≥n para cualquier puesto que se ajuste a su perfil, pues estoy seguro que ser√° un gran activo para cualquier equipo.

Para cualquier duda o aclaraci√≥n, estoy a su disposici√≥n.</textarea>
            </div>
            <div class="input-group">
                <h2>‚úçÔ∏è Datos del Firmante</h2>
                <label for="nombreFirmanteLaboral">Nombre Completo del Firmante:</label>
                <input type="text" id="nombreFirmanteLaboral" value="JOSE GARCIA CHAIDEZ">

                <label for="cargoFirmanteLaboral">Cargo del Firmante:</label>
                <input type="text" id="cargoFirmanteLaboral" value="Director de Recursos Humanos">

                <label for="telefonoFirmanteLaboral">Tel√©fono de Contacto:</label>
                <input type="text" id="telefonoFirmanteLaboral" value="T. (442) 880 1675">
            </div>

            <button class="btn-action" onclick="saveSolicitud('laboral')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
        </div>

        <div id="form-personal" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>üè† Formulario de Carta Personal</h2>

            <div class="input-group">
                <h2>üìù Datos de la Solicitud</h2>
                <label for="nombreSolicitantePersonal">Tu Nombre Completo (Quien Pide la Carta):</label>
                <input type="text" id="nombreSolicitantePersonal" value="Nombre del Solicitante">

                <label for="emailSolicitantePersonal">Tu Correo Electr√≥nico (Solo para referencia):</label>
                <input type="text" id="emailSolicitantePersonal" value="solicitante@ejemplo.com">
            </div>
            
            <div class="input-group">
                <h2>‚úçÔ∏è Datos del Firmante (Recomendador)</h2>
                <label for="fechaEmisionPersonal">Fecha de Emisi√≥n de la Carta:</label>
                <input type="date" id="fechaEmisionPersonal" value="2025-10-24">

                <label for="nombreFirmantePersonal">Nombre Completo del Recomendador:</label>
                <input type="text" id="nombreFirmantePersonal" value="MARIA ISABEL L√ìPEZ P√âREZ">
                
                <label for="firmaInputPersonal">Insertar Firma del Recomendador:</label>
                <input type="file" id="firmaInputPersonal" accept="image/*">
            </div>
            <div class="input-group">
                <h2>üë§ Datos de la Persona Recomendada</h2>
                <label for="nombreRecomendadoPersonal">Nombre Completo de la Persona Recomendada:</label>
                <input type="text" id="nombreRecomendadoPersonal" value="JUAN CARLOS RAM√çREZ SOTO">

                <label for="tiempoConocidoPersonal">Tiempo que conoce a la persona (Ej: 5 a√±os):</label>
                <input type="text" id="tiempoConocidoPersonal" value="Desde hace 8 a√±os">
            </div>
            <div class="input-group">
                <h2>üìù Contenido de la Carta</h2>
                
                <label for="cuerpoPersonalidadPersonal">P√°rrafo de Cualidades y Personalidad:</label>
                <textarea id="cuerpoPersonalidadPersonal">Conozco a [nombre] desde hace 8 a√±os en un contexto social y comunitario. Siempre ha demostrado ser una persona de gran integridad, honesta y de palabra. Destaca por su madurez, su compromiso en las actividades que realiza y su excelente trato interpersonal. Es alguien en quien se puede confiar plenamente.</textarea>
                
                <label for="cuerpoRecomendacionPersonal">P√°rrafo de Recomendaci√≥n y Cierre:</label>
                <textarea id="cuerpoRecomendacionPersonal">Recomiendo a [nombre] sin ninguna reserva para cualquier prop√≥sito que requiera de una persona con s√≥lidos valores y √©tica. Estoy seguro/a de que su car√°cter y responsabilidad ser√°n de gran valor.

Para cualquier duda o aclaraci√≥n, estoy a su disposici√≥n.</textarea>
            </div>

            <button class="btn-action" onclick="saveSolicitud('personal')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
        </div>
        
        <div id="form-receta_similares" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>üíä Formulario de Receta M√©dica SIMILARES</h2>
            
            <div class="input-group">
                <h2>üë®‚Äç‚öïÔ∏è Datos del M√©dico y Emisi√≥n</h2>
                <label for="doctorNombreSimilares">Nombre del M√©dico (Ej: Dr. DUARTE ABDALA MARIO RAFAEL):</label>
                <input type="text" id="doctorNombreSimilares" value="Dr. DUARTE ABDALA MARIO RAFAEL">

                <label for="cedulaSimilares">C√©dula Profesional / Prof. / Especialidad:</label>
                <input type="text" id="cedulaSimilares" value="MEDICO SUB ESPECIALISTA / PROF.: 5164506"> <label for="direccionSimilares">Direcci√≥n del Consultorio (Ej: AV. PDTE. PLUTARCO EL√çAS CALLES 1613, COL. ALBERT.):</label>
                <input type="text" id="direccionSimilares" value="AV. PDTE. PLUTARCO EL√çAS CALLES 1613, COL. ALBERT. C.P. 03560, BENITO JUAREZ">

                <label for="ciudadSimilares">Ciudad (Ej: CIUDAD DE M√âXICO):</label>
                <input type="text" id="ciudadSimilares" value="CIUDAD DE M√âXICO">

                <label for="fechaEmisionSimilares">Fecha de Emisi√≥n de la Receta:</label>
                <input type="date" id="fechaEmisionSimilares" value="2021-03-22"> <label for="logoInputSimilares">Insertar Logo de la Instituci√≥n/Receta (Opcional):</label>
                <input type="file" id="logoInputSimilares" accept="image/*">
            </div>

            <div class="input-group">
                <h2>üë§ Datos del Paciente</h2>
                <label for="nombrePacienteSimilares">Nombre(s) del Paciente:</label>
                <input type="text" id="nombrePacienteSimilares" value="JHOANA MUZME">
                
                <div class="date-container">
                    <div>
                        <label for="apellidoPSimilares">Apellido Paterno:</label>
                        <input type="text" id="apellidoPSimilares" value="SANCHEZ">
                    </div>
                    <div>
                        <label for="apellidoMSimilares">Apellido Materno:</label>
                        <input type="text" id="apellidoMSimilares" value="LARA">
                    </div>
                </div>
                
                <div class="date-container">
                    <div>
                        <label for="sexoSimilares">Sexo (Ej: FEMENINO):</label>
                        <input type="text" id="sexoSimilares" value="FEMENINO">
                    </div>
                    <div>
                        <label for="edadSimilares">Edad:</label>
                        <input type="text" id="edadSimilares" value="18 A√ëOS">
                    </div>
                </div>
                
                <label for="fechaNacSimilares">Fecha de Nacimiento (Para la receta):</label>
                <input type="date" id="fechaNacSimilares" value="2002-09-26"> <label for="alergiasSimilares">Alergias (Ej: NEGADAS):</label>
                <input type="text" id="alergiasSimilares" value="NEGADAS">
            </div>
            
            <div class="input-group">
                <h2>üìà Signos Vitales y Medidas</h2>
                <div class="date-container">
                    <div>
                        <label for="spo2Similares">SpO2 (Ej: 99%):</label>
                        <input type="text" id="spo2Similares" value="99%">
                    </div>
                    <div>
                        <label for="fcSimilares">F.C. (Ej: 78 x min.):</label>
                        <input type="text" id="fcSimilares" value="73 xmin"> </div>
                </div>
                <div class="date-container">
                    <div>
                        <label for="frSimilares">F.R. (Ej: 20 x min.):</label>
                        <input type="text" id="frSimilares" value="20 xmin">
                    </div>
                    <div>
                        <label for="tempSimilares">Temp. (Ej: 36.5¬∞C):</label>
                        <input type="text" id="tempSimilares" value="36.5¬∞C">
                    </div>
                </div>
                <div class="date-container">
                    <div>
                        <label for="pesoSimilares">Peso (Ej: 78 Kg):</label>
                        <input type="text" id="pesoSimilares" value="78 Kg">
                    </div>
                    <div>
                        <label for="tallaSimilares">Talla (Ej: 1.60 M):</label>
                        <input type="text" id="tallaSimilares" value="1.60 M">
                    </div>
                </div>
                <label for="dxSimilares">Diagn√≥stico/Motivo de Consulta (Ej: *I.D. DISPEPSIA FUNCIONAL):</label>
                <input type="text" id="dxSimilares" value="I.D. DISPEPSIA FUNCIONAL">
            </div>
            
            <div class="input-group">
                <h2>üìù Contenido de la Receta</h2>
                <label for="contenidoConsultaSimilares">Contenido de la Consulta (Texto Justificado del Paciente):</label>
                <textarea id="contenidoConsultaSimilares">Paciente acude a consulta m√©dica con dolor abdominal, diarrea con episodios agudos y malestar general. Esto debido a alguna toxina de alg√∫n alimento. Sin presentar fiebre.</textarea>

                <label for="tratamientoSimilares">TRATAMIENTO (Una l√≠nea por medicamento, incluyendo dosis y duraci√≥n):</label>
                <textarea id="tratamientoSimilares">1.- TRIMETOPRINA 800 MG
UNA CADA 8HRS DURANTE 10 DIAS
VIA DE ADMINISTRACION ORAL
2.- BUTILHIOSCINA 20 MG
UNA CADA 12 HRS DURANTE 5 DIAS
VIA DE ADMINISTRACION ORAL
3.- DIFENIDOL 50 MG
UNA CADA 12 HRS DURANE 3 DIAS
VIA DE ADMINISTRACION ORAL
4.- PARACETAMOL 500 MG
UNA CADA 12 HRSDURANTE 5 DIAS
VIA DE ADMINISTRACION ORAL</textarea> <label for="indicacionesGeneralesSimilares">Indicaciones Generales (Una l√≠nea por indicaci√≥n):</label>
                <textarea id="indicacionesGeneralesSimilares">1 D√≠a en reposo</textarea>
                
                <label for="proximaCitaSimilares">Pr√≥xima Cita (Fecha, Ej: 27/08/2021):</label>
                <input type="text" id="proximaCitaSimilares" value="27/03/2021"> <label for="firmaInputSimilares">Insertar Firma del M√©dico (Opcional):</label>
                <input type="file" id="firmaInputSimilares" accept="image/*">
            </div>

            <button class="btn-action" onclick="saveSolicitud('receta_similares')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
        </div>


        <div id="form-incapacidad_imss" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>üíä Formulario de Incapacidad IMSS</h2>
            <div class="input-group">
                <p>‚ö†Ô∏è **FORMULARIO PENDIENTE:** Agregue los campos espec√≠ficos para la Incapacidad IMSS aqu√≠.</p>
                <label for="placeholder1_incapacidad">Ejemplo de Campo (a borrar):</label>
                <input type="text" id="placeholder1_incapacidad" value="">
            </div>
            <button class="btn-action" onclick="saveSolicitud('incapacidad_imss')">üíæ Guardar Solicitud</button>
        </div>
        
        <div id="form-receta_ahorro" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>üíä Formulario de Receta M√©dica DEL AHORRO</h2>
            <div class="input-group">
                <p>‚ö†Ô∏è **FORMULARIO PENDIENTE:** Agregue los campos espec√≠ficos para la Receta Del Ahorro aqu√≠.</p>
                <label for="placeholder1_ahorro">Ejemplo de Campo (a borrar):</label>
                <input type="text" id="placeholder1_ahorro" value="">
            </div>
            <button class="btn-action" onclick="saveSolicitud('receta_ahorro')">üíæ Guardar Solicitud</button>
        </div>
        <div id="form-receta_imss" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>üíä Formulario de Receta M√©dica IMSS</h2>
            <div class="input-group">
                <p>‚ö†Ô∏è **FORMULARIO PENDIENTE:** Agregue los campos espec√≠ficos para la Receta IMSS aqu√≠.</p>
                <label for="placeholder1_imss">Ejemplo de Campo (a borrar):</label>
                <input type="text" id="placeholder1_imss" value="">
            </div>
            <button class="btn-action" onclick="saveSolicitud('receta_imss')">üíæ Guardar Solicitud</button>
        </div>

        <div id="form-cert_primaria" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>üéì Formulario de Certificado de PRIMARIA</h2>
            <div class="input-group">
                <p>‚ö†Ô∏è **FORMULARIO PENDIENTE:** Agregue los campos espec√≠ficos para el Certificado Primaria aqu√≠.</p>
                <label for="placeholder1_primaria">Ejemplo de Campo (a borrar):</label>
                <input type="text" id="placeholder1_primaria" value="">
            </div>
            <button class="btn-action" onclick="saveSolicitud('cert_primaria')">üíæ Guardar Solicitud</button>
        </div>
        <div id="form-cert_secundaria" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>üéì Formulario de Certificado de SECUNDARIA</h2>
            <div class="input-group">
                <p>‚ö†Ô∏è **FORMULARIO PENDIENTE:** Agregue los campos espec√≠ficos para el Certificado Secundaria aqu√≠.</p>
                <label for="placeholder1_secundaria">Ejemplo de Campo (a borrar):</label>
                <input type="text" id="placeholder1_secundaria" value="">
            </div>
            <button class="btn-action" onclick="saveSolicitud('cert_secundaria')">üíæ Guardar Solicitud</button>
        </div>
        <div id="form-cert_prepa" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>üéì Formulario de Certificado de PREPARATORIA</h2>
            <div class="input-group">
                <p>‚ö†Ô∏è **FORMULARIO PENDIENTE:** Agregue los campos espec√≠ficos para el Certificado Prepa aqu√≠.</p>
                <label for="placeholder1_prepa">Ejemplo de Campo (a borrar):</label>
                <input type="text" id="placeholder1_prepa" value="">
            </div>
            <button class="btn-action" onclick="saveSolicitud('cert_prepa')">üíæ Guardar Solicitud</button>
        </div>

        <div id="form-metodo_shein" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>‚≠ê Solicitud de Metodo Shein</h2>
            <div class="input-group">
                <p>‚ö†Ô∏è **FORMULARIO PENDIENTE:** Agregue los campos para el Metodo Shein aqu√≠.</p>
                <label for="placeholder1_shein">Ejemplo de Campo (a borrar):</label>
                <input type="text" id="placeholder1_shein" value="">
            </div>
            <button class="btn-action" onclick="saveSolicitud('metodo_shein')">üíæ Guardar Solicitud</button>
        </div>
        <div id="form-metodo_cinepolis" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>‚≠ê Solicitud de Metodo Cin√©polis</h2>
            <div class="input-group">
                <p>‚ö†Ô∏è **FORMULARIO PENDIENTE:** Agregue los campos para el Metodo Cin√©polis aqu√≠.</p>
                <label for="placeholder1_cinepolis">Ejemplo de Campo (a borrar):</label>
                <input type="text" id="placeholder1_cinepolis" value="">
            </div>
            <button class="btn-action" onclick="saveSolicitud('metodo_cinepolis')">üíæ Guardar Solicitud</button>
        </div>
        <div id="form-metodo_temu" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>‚≠ê Solicitud de Metodo TEMU</h2>
            <div class="input-group">
                <p>‚ö†Ô∏è **FORMULARIO PENDIENTE:** Agregue los campos para el Metodo TEMU aqu√≠.</p>
                <label for="placeholder1_temu">Ejemplo de Campo (a borrar):</label>
                <input type="text" id="placeholder1_temu" value="">
            </div>
            <button class="btn-action" onclick="saveSolicitud('metodo_temu')">üíæ Guardar Solicitud</button>
        </div>
        <div id="form-cv_desde_cero" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>‚≠ê Solicitud de CV DESDE CERO</h2>
            <div class="input-group">
                <p>‚ö†Ô∏è **FORMULARIO PENDIENTE:** Agregue los campos para el CV aqu√≠.</p>
                <label for="placeholder1_cv">Ejemplo de Campo (a borrar):</label>
                <input type="text" id="placeholder1_cv" value="">
            </div>
            <button class="btn-action" onclick="saveSolicitud('cv_desde_cero')">üíæ Guardar Solicitud</button>
        </div>
        <div id="form-sellos_personales" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>‚≠ê Solicitud de SELLOS PERSONALES</h2>
            <div class="input-group">
                <p>‚ö†Ô∏è **FORMULARIO PENDIENTE:** Agregue los campos para los Sellos aqu√≠.</p>
                <label for="placeholder1_sellos">Ejemplo de Campo (a borrar):</label>
                <input type="text" id="placeholder1_sellos" value="">
            </div>
            <button class="btn-action" onclick="saveSolicitud('sellos_personales')">üíæ Guardar Solicitud</button>
        </div>
        <div id="form-formato_solicitud_pdf" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>‚≠ê Solicitud de FORMATO DE SOLICITUD EN PDF</h2>
            <div class="input-group">
                <p>‚ö†Ô∏è **FORMULARIO PENDIENTE:** Agregue los campos para el Formato PDF aqu√≠.</p>
                <label for="placeholder1_formato">Ejemplo de Campo (a borrar):</label>
                <input type="text" id="placeholder1_formato" value="">
            </div>
            <button class="btn-action" onclick="saveSolicitud('formato_solicitud_pdf')">üíæ Guardar Solicitud</button>
        </div>
    </div>

    <div id="status-page" class="status-page" style="display:none;">
        <div class="disclaimer-notice">
            *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
        </div>
    </div>

    <a href="https://wa.me/message/AZLK65CETSPQL1" class="whatsapp-float" target="_blank">
        <i class="fab fa-whatsapp"></i>
    </a>

    <div class="fixed-payment-info">
        <p>‚ö†Ô∏è **PAGO**</p>
        <p>*PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*</p>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        
        // --- CONSTANTES DE ALMACENAMIENTO ---
        const STORAGE_KEY = 'pending_requests_list';
        const APPROVED_KEY = 'approved_requests_list';
        const USER_STORAGE_KEY = 'registered_users'; // NUEVO: Clave para usuarios registrados
        const LOGGED_IN_USER_KEY = 'logged_in_user_id'; // NUEVO: Clave para la sesi√≥n activa

        // --- CREDENCIALES FIJAS DEL ADMINISTRADOR ---
        const ADMIN_USER = 'trollgaga999@gmail.com';
        const ADMIN_PASS = 'Johan207';
        
        let statusCheckInterval = null;

        // --- FUNCIONES DE REGISTRO Y AUTENTICACI√ìN DE CLIENTES (NUEVO) ---

        // Funci√≥n para generar un ID de usuario √∫nico simple (el "user" que pide el cliente)
        function generateUserId(nombreCompleto) {
            const nameParts = nombreCompleto.split(' ').filter(p => p.length > 0);
            let nameAcronym = nameParts.length > 0 ? nameParts.map(p => p.charAt(0)).join('').toUpperCase() : 'CLT';
            // Limitar a 4 letras y agregar un n√∫mero aleatorio para hacerlo √∫nico
            nameAcronym = nameAcronym.substring(0, 4);
            const randomPart = Math.floor(1000 + Math.random() * 9000); // N√∫mero de 4 d√≠gitos
            return `${nameAcronym}-${randomPart}`;
        }

        function registerUser() {
            const email = document.getElementById('regEmail').value.trim();
            const pass = document.getElementById('regPass').value;
            const passVerify = document.getElementById('regPassVerify').value;
            const nombre = document.getElementById('regNombreCompleto').value.trim();
            const fechaNac = document.getElementById('regFechaNac').value;
            const curp = document.getElementById('regCurp').value.trim().toUpperCase();

            // 1. Validaciones
            if (!email || !pass || !passVerify || !nombre || !fechaNac || !curp) {
                alert('Por favor, complete todos los campos.');
                return;
            }
            if (pass.length < 6) {
                alert('La contrase√±a debe tener al menos 6 caracteres.');
                return;
            }
            if (pass !== passVerify) {
                alert('La contrase√±a y su verificaci√≥n no coinciden. Por favor, verifique.');
                return;
            }
            // Simple CURP validation (18 chars)
            if (curp.length !== 18) {
                 alert('El CURP debe tener 18 caracteres.');
                 return;
            }

            // 2. Cargar usuarios existentes y verificar duplicidad de email
            const users = JSON.parse(localStorage.getItem(USER_STORAGE_KEY) || '{}');
            const existingUser = Object.values(users).find(user => user.email.toLowerCase() === email.toLowerCase());
            if (existingUser) {
                alert('Ya existe una cuenta registrada con este correo electr√≥nico.');
                return;
            }

            // 3. Generar ID de Cliente (el "user" para el cliente)
            const userId = generateUserId(nombre);
            // Verificar si el ID ya existe (en caso de colisi√≥n rara)
            if (users[userId]) {
                 alert('Error al generar ID. Intente registrarse de nuevo.');
                 return;
            }

            // 4. Crear objeto de usuario (ADVERTENCIA: Contrase√±a en texto plano para el ejemplo)
            const newUser = {
                userId: userId,
                email: email,
                password: pass, 
                nombreCompleto: nombre,
                fechaNacimiento: fechaNac,
                curp: curp
            };

            // 5. Almacenar el nuevo usuario
            users[userId] = newUser;
            localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(users));

            // 6. Mostrar mensaje de √©xito y el ID de Cliente
            document.getElementById('generatedUserId').textContent = userId;
            document.querySelector('#user-registration .input-group').style.display = 'none'; // Ocultar form
            document.getElementById('registration-success').style.display = 'block';
        }

        function authenticateUser() {
            const userId = document.getElementById('clientUserId').value.trim().toUpperCase();
            const pass = document.getElementById('clientPass').value;
            
            const users = JSON.parse(localStorage.getItem(USER_STORAGE_KEY) || '{}');
            const user = users[userId];

            if (user && user.password === pass) {
                // Login exitoso
                localStorage.setItem(LOGGED_IN_USER_KEY, userId);
                
                // Actualizar vista del dashboard de usuario
                document.getElementById('loggedInUserName').textContent = user.nombreCompleto.split(' ')[0];
                document.querySelector('#user-login .input-group').style.display = 'none';
                document.getElementById('user-dashboard').style.display = 'block';
                
            } else {
                alert('ID de Cliente o Contrase√±a incorrectos.');
            }
        }

        function logoutUser() {
            localStorage.removeItem(LOGGED_IN_USER_KEY);
            // Recargar vista de login
            document.getElementById('clientUserId').value = '';
            document.getElementById('clientPass').value = '';
            document.querySelector('#user-login .input-group').style.display = 'block';
            document.getElementById('user-dashboard').style.display = 'none';
            showForm('user_registration'); // Vuelve a la pantalla de registro
        }

        // Funci√≥n para revisar si el usuario est√° logueado al cargar la vista 'user_login'
        function checkUserLoginStatus() {
            const loggedInUserId = localStorage.getItem(LOGGED_IN_USER_KEY);
            const loginFormGroup = document.querySelector('#user-login .input-group');
            const userDashboard = document.getElementById('user-dashboard');

            // Limpiar inputs del login al entrar
            document.getElementById('clientUserId').value = '';
            document.getElementById('clientPass').value = '';


            if (loggedInUserId) {
                const users = JSON.parse(localStorage.getItem(USER_STORAGE_KEY) || '{}');
                const user = users[loggedInUserId];
                if (user) {
                    document.getElementById('loggedInUserName').textContent = user.nombreCompleto.split(' ')[0];
                    loginFormGroup.style.display = 'none';
                    userDashboard.style.display = 'block';
                    return;
                }
            }
            // Si no est√° logueado o el ID no es v√°lido
            loginFormGroup.style.display = 'block';
            userDashboard.style.display = 'none';
        }

        // --- MANEJO DE URL Y VISTAS (MODIFICADO para empezar en registro) ---

        function getBaseUrl() {
            return window.location.href.split('#')[0];
        }

        // Funci√≥n que determina qu√© vista mostrar al cargar o al retroceder
        function checkURL(event) {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }

            // 1. Obtener el estado actual (si viene del history.back/forward)
            const state = history.state;
            let viewId = state ? state.viewId : null; // Inicia como null
            let requestId = state ? state.requestId : null;

            // 2. Si no viene del estado, verificar el hash (para links directos/actualizaci√≥n)
            if (!viewId) { 
                const hash = window.location.hash.substring(1);
                const params = new URLSearchParams(hash.split('?')[1] || '');
                requestId = params.get('id');

                if (hash.startsWith('status') && requestId) {
                    viewId = 'status';
                } else if (hash.startsWith('admin')) {
                    viewId = hash.split('?')[0];
                } else if (hash.startsWith('user_login')) { 
                     viewId = 'user_login';
                } else if (hash.startsWith('user_registration')) { 
                     viewId = 'user_registration';
                } else if (hash.startsWith('menu')) { // Si viene del hash menu, lo mostramos
                     viewId = 'menu';
                } else {
                     viewId = 'user_registration'; // MODIFICADO: EL REGISTRO ES LA PANTALLA INICIAL
                }
            }
            
            // 3. Renderizar la vista correspondiente
            document.getElementById('status-page').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';

            if (viewId === 'status' && requestId) {
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('status-page').style.display = 'flex'; 
                document.getElementById('status-page').innerHTML = '<div class="disclaimer-notice">*NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*</div>';
                checkStatus(requestId);
                statusCheckInterval = setInterval(() => checkStatus(requestId), 5000);
                return;
            }

            // Si la vista es admin_dashboard, asegurar que se carguen los datos
            if (viewId === 'admin_dashboard') {
                loadPendingRequests();
            }
            
            // Si la vista es user_login, verificar el estado del cliente
            if (viewId === 'user_login') {
                checkUserLoginStatus();
            }

            // Mostrar el contenedor de la aplicaci√≥n y la vista espec√≠fica
            showForm(viewId, false); // No empujar estado al historial si ya estamos retrocediendo/cargando
        }

        // Mapeo de IDs de vista a IDs de elementos DIV
        const viewIdMap = {
            'menu': 'main-menu',
            'laboral': 'form-laboral',
            'personal': 'form-personal',
            'admin_login': 'admin-login',
            'admin_dashboard': 'admin-dashboard',
            'user_login': 'user-login', 
            'user_registration': 'user-registration', 
            'incapacidad_imss': 'form-incapacidad_imss',
            'receta_similares': 'form-receta_similares',
            'receta_ahorro': 'form-receta_ahorro',
            'receta_imss': 'form-receta_imss',
            'cert_primaria': 'form-cert_primaria',
            'cert_secundaria': 'form-cert_secundaria',
            'cert_prepa': 'form-cert_prepa',
            'metodo_shein': 'form-metodo_shein',
            'metodo_cinepolis': 'form-metodo_cinepolis',
            'metodo_temu': 'form-metodo_temu',
            'cv_desde_cero': 'form-cv_desde_cero',
            'sellos_personales': 'form-sellos_personales',
            'formato_solicitud_pdf': 'form-formato_solicitud_pdf',
            'whatsapp_group': 'main-menu' 
        };

        function showForm(formId, pushState = true) {
            // Detener la verificaci√≥n de estatus si estaba activa
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }

            // Caso especial para el link de WhatsApp
            if (formId === 'whatsapp_group') {
                window.open('https://wa.me/message/AZLK65CETSPQL1', '_blank');
                return;
            }

            // Ocultar todos los formularios y el men√∫ principal
            document.querySelectorAll('.form-section').forEach(form => {
                form.style.display = 'none';
            });
            document.getElementById('main-menu').style.display = 'none';

            // Determinar qu√© elemento mostrar
            const elementId = viewIdMap[formId] || 'user-registration'; // Default a registration
            const targetElement = document.getElementById(elementId);

            if (targetElement) {
                targetElement.style.display = 'block';
                
                // L√≥gica espec√≠fica al mostrar ciertos formularios
                if (formId === 'admin_dashboard') {
                    loadPendingRequests();
                } else if (formId === 'user_login') { 
                    checkUserLoginStatus();
                } else if (formId === 'user_registration') { 
                     document.querySelector('#user-registration .input-group').style.display = 'block';
                     document.getElementById('registration-success').style.display = 'none';
                }

                // Si se debe agregar al historial (usualmente s√≠, a menos que se indique lo contrario)
                if (pushState) {
                    history.pushState({ viewId: formId }, '', `${getBaseUrl()}#${formId}`);
                }
            } else {
                // Si el ID del formulario no se encuentra, volver al REGISTRO (nueva pantalla inicial)
                document.getElementById('user-registration').style.display = 'block';
                if (pushState) {
                    history.pushState({ viewId: 'user_registration' }, '', `${getBaseUrl()}#user_registration`);
                }
            }
        }

        // --- MANEJO DE ADMINISTRADOR ---
        
        function authenticateAdmin() {
            const user = document.getElementById('adminUser').value.trim();
            const pass = document.getElementById('adminPass').value.trim();

            if (user === ADMIN_USER && pass === ADMIN_PASS) {
                document.getElementById('adminUser').value = '';
                document.getElementById('adminPass').value = '';
                showForm('admin_dashboard');
            } else {
                alert('Credenciales de administrador incorrectas.');
            }
        }

        function loadPendingRequests() {
            const listContainer = document.getElementById('pending-requests-list');
            const noRequestsMsg = document.getElementById('no-requests-msg');
            const pendingRequests = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            
            listContainer.innerHTML = ''; // Limpiar lista
            
            if (pendingRequests.length === 0) {
                noRequestsMsg.style.display = 'block';
                listContainer.appendChild(noRequestsMsg);
                return;
            }
            
            noRequestsMsg.style.display = 'none';

            pendingRequests.forEach(request => {
                const item = document.createElement('div');
                item.className = 'request-item';
                item.innerHTML = `
                    <div>
                        <strong>Tipo:</strong> ${request.type} <br>
                        <strong>ID Solicitud:</strong> ${request.id} <br>
                        <strong>Solicitante:</strong> ${request.data.nombreSolicitante || request.data.nombrePacienteSimilares || 'N/A'} <br>
                        <strong>Email:</strong> ${request.data.emailSolicitante || request.data.emailSolicitanteLaboral || 'N/A'}
                    </div>
                    <div class="request-actions">
                        <button class="btn-action btn-authorize" onclick="authorizeRequest('${request.id}')">Autorizar</button>
                        <button class="btn-action btn-reject" onclick="rejectRequest('${request.id}')" style="background-color: #c0392b;">Rechazar</button>
                        <button class="btn-action back-button" onclick="viewRequestData('${request.id}')" style="background-color: #34495e;">Ver Detalles</button>
                    </div>
                    <div id="details-${request.id}" style="display:none; width:100%; margin-top:10px; border-top: 1px solid #eee; padding-top: 10px;">
                        <h4>Detalles de la Solicitud:</h4>
                        <pre style="white-space: pre-wrap; word-break: break-all; font-size: 0.8em; background-color: #f7f7f7; padding: 10px; border-radius: 4px;">${JSON.stringify(request.data, null, 2)}</pre>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        }

        function viewRequestData(requestId) {
            const detailsDiv = document.getElementById(`details-${requestId}`);
            detailsDiv.style.display = detailsDiv.style.display === 'none' ? 'block' : 'none';
        }

        function authorizeRequest(requestId) {
            const pendingRequests = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const approvedRequests = JSON.parse(localStorage.getItem(APPROVED_KEY) || '[]');
            
            const requestIndex = pendingRequests.findIndex(req => req.id === requestId);
            
            if (requestIndex !== -1) {
                const [approvedRequest] = pendingRequests.splice(requestIndex, 1);
                
                // Marcar como autorizado
                approvedRequest.authorized = true;
                approvedRequest.approvalDate = new Date().toISOString();

                // Generar el PDF y obtener el base64 si es posible
                let pdfBase64 = null;
                const type = approvedRequest.type.toLowerCase();
                if (type.includes('carta laboral') || type.includes('carta personal') || type.includes('receta m√©dica similares')) {
                     pdfBase64 = generatePDF(type, approvedRequest.data, false); // No descargar, solo obtener base64
                } else {
                     // Para otros tipos, se simula un enlace o se indica que el documento est√° 'listo'
                     pdfBase64 = btoa("Documento Autorizado, pendiente de generaci√≥n de PDF espec√≠fico."); 
                }

                approvedRequest.pdfBase64 = pdfBase64;
                
                approvedRequests.push(approvedRequest);

                // Guardar cambios
                localStorage.setItem(STORAGE_KEY, JSON.stringify(pendingRequests));
                localStorage.setItem(APPROVED_KEY, JSON.stringify(approvedRequests));
                
                loadPendingRequests(); // Recargar el dashboard
                alert(`Solicitud ${requestId} autorizada y lista para descarga.`);
            } else {
                alert('Error: Solicitud no encontrada.');
            }
        }

        function rejectRequest(requestId) {
            if (!confirm(`¬øEst√° seguro que desea rechazar la solicitud ${requestId}? Esto la eliminar√°.`)) {
                return;
            }

            const pendingRequests = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const requestIndex = pendingRequests.findIndex(req => req.id === requestId);

            if (requestIndex !== -1) {
                pendingRequests.splice(requestIndex, 1);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(pendingRequests));
                loadPendingRequests(); // Recargar el dashboard
                alert(`Solicitud ${requestId} rechazada y eliminada.`);
            } else {
                alert('Error: Solicitud no encontrada.');
            }
        }

        // --- MANEJO DE SOLICITUDES DEL CLIENTE ---

        function getFileBase64(type) {
            const fileInputs = [];
            
            if (type === 'laboral') {
                fileInputs.push({ key: 'logoBase64Laboral', id: 'logoInputLaboral' });
                fileInputs.push({ key: 'firmaBase64Laboral', id: 'firmaInputLaboral' });
            } else if (type === 'personal') {
                fileInputs.push({ key: 'firmaBase64Personal', id: 'firmaInputPersonal' });
            } else if (type === 'receta_similares') {
                fileInputs.push({ key: 'logoBase64Similares', id: 'logoInputSimilares' });
                fileInputs.push({ key: 'firmaBase64Similares', id: 'firmaInputSimilares' });
            }
            
            const promises = fileInputs.map(input => {
                const file = document.getElementById(input.id).files[0];
                return new Promise((resolve, reject) => {
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = () => {
                            resolve({ key: input.key, base64: reader.result });
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    } else {
                        resolve({ key: input.key, base64: null });
                    }
                });
            });

            return promises;
        }

        function extractFormData(type) {
            let data = {};
            let missing = false;

            if (type === 'laboral') {
                data = {
                    nombreSolicitante: document.getElementById('nombreSolicitanteLaboral').value,
                    emailSolicitante: document.getElementById('emailSolicitanteLaboral').value,
                    fechaEmision: document.getElementById('fechaEmisionLaboral').value,
                    nombreEmpleado: document.getElementById('nombreEmpleadoLaboral').value,
                    puestoDesempenado: document.getElementById('puestoDesempenadoLaboral').value,
                    fechaInicio: document.getElementById('fechaInicioLaboral').value,
                    fechaFin: document.getElementById('fechaFinLaboral').value,
                    nombreEmpresa: document.getElementById('nombreEmpresaLaboral').value,
                    cuerpoPersonalidad: document.getElementById('cuerpoPersonalidadLaboral').value,
                    tareas: document.getElementById('tareasLaboral').value,
                    cuerpoCierre: document.getElementById('cuerpoCierreLaboral').value,
                    nombreFirmante: document.getElementById('nombreFirmanteLaboral').value,
                    cargoFirmante: document.getElementById('cargoFirmanteLaboral').value,
                    telefonoFirmante: document.getElementById('telefonoFirmanteLaboral').value,
                };
                if (!data.nombreSolicitante || !data.nombreEmpleado || !data.nombreFirmante) missing = true;

            } else if (type === 'personal') {
                 data = {
                    nombreSolicitante: document.getElementById('nombreSolicitantePersonal').value,
                    emailSolicitante: document.getElementById('emailSolicitantePersonal').value,
                    fechaEmision: document.getElementById('fechaEmisionPersonal').value,
                    nombreFirmante: document.getElementById('nombreFirmantePersonal').value,
                    nombreRecomendado: document.getElementById('nombreRecomendadoPersonal').value,
                    tiempoConocido: document.getElementById('tiempoConocidoPersonal').value,
                    cuerpoPersonalidad: document.getElementById('cuerpoPersonalidadPersonal').value,
                    cuerpoRecomendacion: document.getElementById('cuerpoRecomendacionPersonal').value,
                };
                if (!data.nombreSolicitante || !data.nombreRecomendado || !data.nombreFirmante) missing = true;
                
            } else if (type === 'receta_similares') {
                data = {
                    nombreSolicitante: document.getElementById('nombrePacienteSimilares').value + ' ' + document.getElementById('apellidoPSimilares').value,
                    doctorNombre: document.getElementById('doctorNombreSimilares').value,
                    cedula: document.getElementById('cedulaSimilares').value,
                    direccion: document.getElementById('direccionSimilares').value,
                    ciudad: document.getElementById('ciudadSimilares').value,
                    fechaEmision: document.getElementById('fechaEmisionSimilares').value,
                    nombrePaciente: document.getElementById('nombrePacienteSimilares').value,
                    apellidoP: document.getElementById('apellidoPSimilares').value,
                    apellidoM: document.getElementById('apellidoMSimilares').value,
                    sexo: document.getElementById('sexoSimilares').value,
                    edad: document.getElementById('edadSimilares').value,
                    fechaNac: document.getElementById('fechaNacSimilares').value,
                    alergias: document.getElementById('alergiasSimilares').value,
                    spo2: document.getElementById('spo2Similares').value,
                    fc: document.getElementById('fcSimilares').value,
                    fr: document.getElementById('frSimilares').value,
                    temp: document.getElementById('tempSimilares').value,
                    peso: document.getElementById('pesoSimilares').value,
                    talla: document.getElementById('tallaSimilares').value,
                    dx: document.getElementById('dxSimilares').value,
                    contenidoConsulta: document.getElementById('contenidoConsultaSimilares').value,
                    tratamiento: document.getElementById('tratamientoSimilares').value,
                    indicacionesGenerales: document.getElementById('indicacionesGeneralesSimilares').value,
                    proximaCita: document.getElementById('proximaCitaSimilares').value,
                };
                if (!data.doctorNombre || !data.nombrePaciente || !data.tratamiento) missing = true;
                
            } else {
                // Para forms pendientes, se usa el placeholder para al menos tener un ID rastreable
                const placeholderId = `placeholder1_${type.split('_')[0]}`;
                const emailInput = document.getElementById(placeholderId);
                data.emailSolicitante = emailInput ? emailInput.value : `${type.split('_')[0]}@ejemplo.com`;
                data.placeholder1 = emailInput ? emailInput.value : 'N/A';
                data.nombreSolicitante = 'Cliente Pendiente';

                // Si son formularios PENDIENTES, no se valida missing para no bloquear la funcionalidad
                missing = false;
            }

            if (missing) {
                alert('Por favor, complete al menos los campos principales marcados como obligatorios.');
                return null;
            }

            return data;
        }

        function getFriendlyName(type) {
            const names = {
                'laboral': 'Carta de Recomendaci√≥n LABORAL',
                'personal': 'Carta de Recomendaci√≥n PERSONAL',
                'incapacidad_imss': 'Incapacidad IMSS',
                'receta_similares': 'Receta M√©dica SIMILARES',
                'receta_ahorro': 'Receta M√©dica DEL AHORRO',
                'receta_imss': 'Receta M√©dica IMSS',
                'cert_primaria': 'Certificado de PRIMARIA',
                'cert_secundaria': 'Certificado de SECUNDARIA',
                'cert_prepa': 'Certificado de PREPARATORIA',
                'metodo_shein': 'Metodo Shein',
                'metodo_cinepolis': 'Metodo Cin√©polis',
                'metodo_temu': 'Metodo TEMU',
                'cv_desde_cero': 'CV DESDE CERO',
                'sellos_personales': 'SELLOS PERSONALES',
                'formato_solicitud_pdf': 'FORMATO DE SOLICITUD EN PDF',
            };
            return names[type] || type.toUpperCase();
        }

        function saveSolicitud(type) {
            // Generar un ID simple y √∫nico para la solicitud
            const uniqueId = 'SOL-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5).toUpperCase();
            
            const requestData = extractFormData(type);
            
            if (!requestData) {
                // extractFormData mostrar√° el error si falta data cr√≠tica
                return;
            }

            // Obtener datos de archivos si existen
            const filePromises = getFileBase64(type);

            Promise.all(filePromises)
                .then(fileResults => {
                    fileResults.forEach(result => {
                        requestData[result.key] = result.base64;
                    });

                    const newRequest = {
                        id: uniqueId,
                        type: getFriendlyName(type),
                        status: 'PENDIENTE',
                        date: new Date().toISOString(),
                        data: requestData
                    };

                    // Guardar en localStorage
                    const existingRequests = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                    existingRequests.push(newRequest);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(existingRequests));
                    
                    // Redirigir a la p√°gina de estatus
                    showForm('status', true);
                    window.location.hash = `status?id=${uniqueId}`;
                })
                .catch(error => {
                    alert('Ocurri√≥ un error al procesar las im√°genes. Por favor, aseg√∫rese de que no sean demasiado grandes.');
                    console.error('Error processing files:', error);
                });
        }
        
        // --- FUNCI√ìN PARA VERIFICAR ESTATUS (IMPORTANTE PARA EL CLIENTE) ---
        function checkStatus(requestId) {
            const statusPage = document.getElementById('status-page');
            const approvedRequests = JSON.parse(localStorage.getItem(APPROVED_KEY) || '[]');
            const pendingRequests = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

            const approvedRequest = approvedRequests.find(req => req.id === requestId);
            const pendingRequest = pendingRequests.find(req => req.id === requestId);

            if (approvedRequest) {
                statusPage.innerHTML = `
                    <div class="disclaimer-notice">
                        *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
                    </div>
                    <h2>‚úÖ Solicitud Aprobada - ${approvedRequest.type}</h2>
                    <p>Su documento ha sido revisado y autorizado. Ya puede descargarlo.</p>
                    <button class="btn-action btn-download-now" onclick="downloadApprovedPDF('${requestId}')">
                        <i class="fas fa-download"></i> DESCARGAR DOCUMENTO AHORA
                    </button>
                    <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫ Principal</button>
                `;
                if (statusCheckInterval) {
                     clearInterval(statusCheckInterval);
                }
            } else if (pendingRequest) {
                statusPage.innerHTML = `
                    <div class="disclaimer-notice">
                        *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
                    </div>
                    <h2>‚è≥ Solicitud Recibida - ${pendingRequest.type}</h2>
                    <div class="spinner"></div>
                    <p>Su solicitud <strong>${requestId}</strong> ha sido recibida y est√° en espera de ser autorizada por el administrador.</p>
                    <p style="font-weight: bold; color: #e67e22;">Estado: PENDIENTE DE REVISI√ìN</p>
                    <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫ Principal</button>
                `;
                // El intervalo sigue corriendo para detectar la aprobaci√≥n
            } else {
                statusPage.innerHTML = `
                    <div class="disclaimer-notice">
                        *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
                    </div>
                    <h2>‚ùå Solicitud No Encontrada</h2>
                    <p>No pudimos encontrar el estatus para el ID de solicitud <strong>${requestId}</strong>. Podr√≠a haber sido rechazada o el ID es incorrecto.</p>
                    <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫ Principal</button>
                `;
                if (statusCheckInterval) {
                     clearInterval(statusCheckInterval);
                }
            }
        }

        function downloadApprovedPDF(requestId) {
            const approvedRequests = JSON.parse(localStorage.getItem(APPROVED_KEY) || '[]');
            const request = approvedRequests.find(req => req.id === requestId);

            if (request && request.pdfBase64) {
                
                // Si ya existe el base64 del PDF generado en la autorizaci√≥n
                const link = document.createElement('a');
                link.href = 'data:application/pdf;base64,' + request.pdfBase64;
                link.download = `${request.type.replace(/[^a-z0-9]/gi, '_')}_${requestId}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Si el PDFBase64 es solo la simulaci√≥n, alertar al usuario
                if (request.pdfBase64 === btoa("Documento Autorizado, pendiente de generaci√≥n de PDF espec√≠fico.")) {
                    alert("El documento ha sido autorizado, pero la generaci√≥n del PDF espec√≠fico para este tipo de solicitud a√∫n est√° pendiente. Se ha descargado un archivo de marcador. Por favor, contacte a soporte si requiere el archivo final.");
                }
            } else {
                alert('Error: El documento no ha sido generado o el ID no es v√°lido.');
            }
        }
        
        
        // --- FUNCI√ìN DE GENERACI√ìN DE PDF (Ejemplo para Cartas y Recetas) ---
        function generatePDF(type, data, descargar = true) {
            const doc = new jsPDF();
            const margen = 15;
            let y = margen;
            let xCentro = doc.internal.pageSize.width / 2;
            doc.setFont('times', 'normal');

            // --- CARTA LABORAL / PERSONAL ---
            if (type.includes('carta')) {
                const nombreSolicitante = type.includes('laboral') ? data.nombreSolicitante : data.nombreRecomendado;
                
                // Header (Fecha y Encabezado)
                doc.setFontSize(11);
                doc.text(`Quer√©taro, Qro., a ${new Date(data.fechaEmision).toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric' })}.`, doc.internal.pageSize.width - margen, y, { align: 'right' });
                y += 10;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('A QUIEN CORRESPONDA:', margen, y);
                y += 10;
                
                doc.setFont(undefined, 'normal');
                doc.text('PRESENTE.', margen, y);
                y += 15;

                // T√≠tulo
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`ASUNTO: CARTA DE RECOMENDACI√ìN ${type.includes('laboral') ? 'LABORAL' : 'PERSONAL'}`, xCentro, y, { align: 'center' });
                y += 10;

                // Contenido
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                
                // P√°rrafo de apertura
                const introText = type.includes('laboral') ?
                    `Por medio de la presente, me permito hacer constar que el C. ${data.nombreEmpleado.toUpperCase()} desempe√±√≥ sus funciones en nuestra empresa ${data.nombreEmpresa.toUpperCase()} durante el per√≠odo comprendido del ${new Date(data.fechaInicio).toLocaleDateString('es-MX')} al ${new Date(data.fechaFin).toLocaleDateString('es-MX')} en el puesto de ${data.puestoDesempenado.toUpperCase()}.` :
                    `Me permito recomendar al C. ${data.nombreRecomendado.toUpperCase()}, a quien conozco ${data.tiempoConocido} y puedo asegurar que es una persona de conducta intachable y probada honradez.`;
                
                const splitIntro = doc.splitTextToSize(introText, doc.internal.pageSize.width - (2 * margen));
                doc.text(splitIntro, margen, y);
                y += (splitIntro.length * 5) + 5;

                // P√°rrafo de personalidad
                const splitPersonalidad = doc.splitTextToSize(data.cuerpoPersonalidad.replace('[nombre]', nombreSolicitante), doc.internal.pageSize.width - (2 * margen));
                doc.text(splitPersonalidad, margen, y);
                y += (splitPersonalidad.length * 5) + 5;

                // Tareas (solo Laboral)
                if (type.includes('laboral') && data.tareas) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Entre sus principales responsabilidades se encontraban:', margen, y);
                    y += 5;
                    doc.setFont(undefined, 'normal');
                    const tareasArray = data.tareas.split('\n').filter(t => t.trim() !== '');
                    tareasArray.forEach(tarea => {
                        doc.text(`‚Ä¢ ${tarea.trim()}`, margen + 5, y);
                        y += 5;
                    });
                    y += 5;
                }

                // P√°rrafo de Cierre y Recomendaci√≥n
                const cierreText = data.cuerpoCierre.replace('[nombre]', nombreSolicitante);
                const splitCierre = doc.splitTextToSize(cierreText, doc.internal.pageSize.width - (2 * margen));
                doc.text(splitCierre, margen, y);
                y += (splitCierre.length * 5) + 10;

                doc.setFont(undefined, 'bold');
                doc.text('ATENTAMENTE', xCentro, y, { align: 'center' });
                y += 20;

                // Firma y datos del firmante
                const nombreFirmante = type.includes('laboral') ? data.nombreFirmante : data.nombreFirmantePersonal;
                const cargoFirmante = type.includes('laboral') ? data.cargoFirmante : 'RECOMENDADOR PARTICULAR';
                
                // L√≠nea para la firma
                doc.line(xCentro - 30, y, xCentro + 30, y);
                y += 5;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text(nombreFirmante.toUpperCase(), xCentro, y, { align: 'center' });
                y += 5;
                doc.setFont(undefined, 'normal');
                doc.text(cargoFirmante.toUpperCase(), xCentro, y, { align: 'center' });
                y += 5;
                
                if (type.includes('laboral') && data.telefonoFirmante) {
                     doc.text(data.telefonoFirmante, xCentro, y, { align: 'center' });
                     y += 5;
                }
                
                // Manejo de imagen de Firma (si existe)
                const firmaBase64 = type.includes('laboral') ? data.firmaBase64Laboral : data.firmaBase64Personal;
                if (firmaBase64) {
                    const imgWidth = 40; 
                    const xFirma = xCentro - (imgWidth / 2);
                    const yFirmaImage = y - 30;
                    doc.addImage(firmaBase64, 'PNG', xFirma, yFirmaImage, imgWidth, 15);
                }
                
                if (descargar) {
                     doc.save(`Carta_${nombreSolicitante.replace(/\\s/g, '_')}_${type.includes('laboral') ? 'LABORAL' : 'PERSONAL'}.pdf`);
                     return true;
                } else {
                     return doc.output('datauristring').split(',')[1];
                }

            // --- RECETA SIMILARES ---
            } else if (type.includes('receta m√©dica similares')) {
                 const nombreDoc = data.doctorNombre;
                 const cedula = data.cedula;
                 const direccion = data.direccion;
                 const ciudad = data.ciudad;
                 const fechaEmision = new Date(data.fechaEmision).toLocaleDateString('es-MX');

                 // Coordenadas fijas para la plantilla
                 const xDoc = 110; // Inicio de los datos del doctor
                 const xPat = 15; // Inicio de los datos del paciente
                 const xCentro = doc.internal.pageSize.width / 2;
                 const yBajo = 250; 
                 
                 // 1. Logo (si existe)
                 const logoBase64 = data.logoBase64Similares;
                 if (logoBase64) {
                     doc.addImage(logoBase64, 'PNG', 15, margen, 40, 20);
                 }
                 
                 // 2. Datos del M√©dico (Similares tiene un formato espec√≠fico)
                 doc.setFontSize(9);
                 doc.setFont(undefined, 'bold');
                 doc.text(nombreDoc.toUpperCase(), xDoc, margen + 2);
                 doc.setFont(undefined, 'normal');
                 doc.text(cedula.toUpperCase(), xDoc, margen + 7);
                 doc.text(direccion.toUpperCase(), xDoc, margen + 12);
                 doc.text(ciudad.toUpperCase(), xDoc, margen + 17);
                 doc.text(`FECHA: ${fechaEmision}`, xDoc, margen + 22);

                 // L√≠nea divisoria
                 doc.line(margen, 45, doc.internal.pageSize.width - margen, 45);
                 
                 // 3. Datos del Paciente (Fijos)
                 let y_pat = 50;
                 doc.setFontSize(10);
                 doc.setFont(undefined, 'bold');
                 doc.text('PACIENTE:', xPat, y_pat);
                 doc.setFont(undefined, 'normal');
                 doc.text(`${data.nombrePaciente.toUpperCase()} ${data.apellidoP.toUpperCase()} ${data.apellidoM.toUpperCase()}`, xPat + 20, y_pat);
                 
                 doc.setFont(undefined, 'bold');
                 doc.text('SEXO:', xPat + 100, y_pat);
                 doc.setFont(undefined, 'normal');
                 doc.text(data.sexo.toUpperCase(), xPat + 110, y_pat);
                 
                 y_pat += 5;
                 doc.setFont(undefined, 'bold');
                 doc.text('EDAD:', xPat, y_pat);
                 doc.setFont(undefined, 'normal');
                 doc.text(data.edad.toUpperCase(), xPat + 12, y_pat);
                 
                 doc.setFont(undefined, 'bold');
                 doc.text('F. NAC:', xPat + 40, y_pat);
                 doc.setFont(undefined, 'normal');
                 doc.text(new Date(data.fechaNac).toLocaleDateString('es-MX'), xPat + 55, y_pat);

                 doc.setFont(undefined, 'bold');
                 doc.text('ALERGIAS:', xPat + 100, y_pat);
                 doc.setFont(undefined, 'normal');
                 doc.text(data.alergias.toUpperCase(), xPat + 120, y_pat);
                 
                 y_pat += 5;
                 doc.setFont(undefined, 'bold');
                 doc.text('DX:', xPat, y_pat);
                 doc.setFont(undefined, 'normal');
                 doc.text(data.dx.toUpperCase(), xPat + 10, y_pat);

                 // 4. Signos Vitales
                 y_pat += 7;
                 doc.setFont(undefined, 'bold');
                 doc.text('SpO2:', xPat, y_pat);
                 doc.setFont(undefined, 'normal');
                 doc.text(data.spo2, xPat + 12, y_pat);

                 doc.setFont(undefined, 'bold');
                 doc.text('F.C.:', xPat + 40, y_pat);
                 doc.setFont(undefined, 'normal');
                 doc.text(data.fc, xPat + 50, y_pat);

                 doc.setFont(undefined, 'bold');
                 doc.text('F.R.:', xPat + 80, y_pat);
                 doc.setFont(undefined, 'normal');
                 doc.text(data.fr, xPat + 90, y_pat);

                 doc.setFont(undefined, 'bold');
                 doc.text('T:', xPat + 120, y_pat);
                 doc.setFont(undefined, 'normal');
                 doc.text(data.temp, xPat + 130, y_pat);

                 doc.setFont(undefined, 'bold');
                 doc.text('PESO:', xPat + 145, y_pat);
                 doc.setFont(undefined, 'normal');
                 doc.text(data.peso, xPat + 158, y_pat);

                 doc.setFont(undefined, 'bold');
                 doc.text('TALLA:', xPat + 175, y_pat);
                 doc.setFont(undefined, 'normal');
                 doc.text(data.talla, xPat + 190, y_pat);

                 // L√≠nea divisoria
                 y_pat += 3;
                 doc.line(margen, y_pat, doc.internal.pageSize.width - margen, y_pat);
                 y_pat += 5;

                 // 5. Contenido de la Consulta
                 doc.setFont(undefined, 'bold');
                 doc.text('CONTENIDO DE LA CONSULTA:', xPat, y_pat);
                 y_pat += 5;
                 doc.setFont(undefined, 'normal');
                 const splitConsulta = doc.splitTextToSize(data.contenidoConsulta, doc.internal.pageSize.width - (2 * margen));
                 doc.text(splitConsulta, xPat, y_pat);
                 y_pat += (splitConsulta.length * 5) + 5;

                 // 6. Tratamiento
                 doc.setFont(undefined, 'bold');
                 doc.text('TRATAMIENTO:', xPat, y_pat);
                 y_pat += 5;
                 doc.setFont(undefined, 'normal');
                 const splitTratamiento = doc.splitTextToSize(data.tratamiento, doc.internal.pageSize.width - (2 * margen));
                 doc.text(splitTratamiento, xPat, y_pat);
                 y_pat += (splitTratamiento.length * 5) + 5;
                 
                 // 7. Indicaciones y Pr√≥xima Cita
                 doc.setFont(undefined, 'bold');
                 doc.text('INDICACIONES GENERALES:', xPat, y_pat);
                 y_pat += 5;
                 doc.setFont(undefined, 'normal');
                 const splitIndicaciones = doc.splitTextToSize(data.indicacionesGenerales, doc.internal.pageSize.width - (2 * margen));
                 doc.text(splitIndicaciones, xPat, y_pat);
                 y_pat += (splitIndicaciones.length * 5) + 5;

                 doc.setFont(undefined, 'bold');
                 doc.text('PR√ìXIMA CITA:', xPat, y_pat);
                 doc.setFont(undefined, 'normal');
                 doc.text(data.proximaCita, xPat + 30, y_pat);

                 // 8. Firma
                 const xFirmaBlock = 160; 
                 const yFirmaLine = yBajo;
                 const yFirmaImage = yFirmaLine - 15;
                 
                 // L√≠nea para la firma
                 doc.line(xFirmaBlock - 20, yFirmaLine, xFirmaBlock + 20, yFirmaLine);
                 
                 // Manejo de imagen de Firma (si existe)
                 const firmaBase64 = data.firmaBase64Similares;
                 if (firmaBase64) {
                     const imgWidth = 40; 
                     const xFirma = xFirmaBlock - (imgWidth / 2); // Centrar sobre la l√≠nea de firma
                     doc.addImage(firmaBase64, 'PNG', xFirma, yFirmaImage, imgWidth, 15);
                 }
                 
                 // Nombre del Doctor (debajo de la l√≠nea de firma)
                 doc.setFontSize(9);
                 doc.setFont(undefined, 'normal');
                 doc.text(nombreDoc, xFirmaBlock, yFirmaLine + 4, { align: 'center' }); 
                 
                 // COPIA (Texto central y bajo)
                 doc.setFontSize(16);
                 doc.setFont(undefined, 'bold');
                 doc.text("COPIA", xCentro, yBajo + 15, { align: 'center' }); 

                 if (descargar) {
                      doc.save(`Receta_${data.nombrePaciente.replace(/\\s/g, '_')}_SIMILARES.pdf`);
                      return true;
                 } else {
                      return doc.output('datauristring').split(',')[1];
                 }
            }
            
            // Retorno por defecto si no es uno de los documentos generados
            return btoa("Documento de Solicitud Recibida.");
        }

        // --- INICIALIZACI√ìN (MODIFICADO) ---

        window.addEventListener('load', () => {
             // Reemplazar la entrada inicial del historial para que el "atr√°s" inicial vaya al REGISTRO.
             if (window.location.hash === '' || window.location.hash === '#menu') {
                 // MODIFICADO: El registro es la pantalla inicial
                 history.replaceState({ viewId: 'user_registration' }, '', `${getBaseUrl()}#user_registration`); 
             }
             checkURL();
        });
        
        // Manejar el bot√≥n de "atr√°s" del navegador
        window.addEventListener('popstate', checkURL);
    </script>
</body>
</html>
